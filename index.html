<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Agora Weather Widget</title>
  <meta name="viewport" content="width=2000">
  <style>
    html, body {
      background: #181e2a;
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      color: #fff;
      font-family: 'Segoe UI', Arial, sans-serif;
    }
    #main-container {
      width: 2000px;
      height: 480px;
      margin: 0 auto;
      display: flex;
      align-items: flex-start;
      background: #181e2a;
      box-shadow: 0 2px 24px #0008;
      border-radius: 18px;
      overflow: hidden;
    }
    #current-block {
      width: 660px;
      min-width: 580px;
      max-width: 820px;
      height: 100%;
      background: #222c40;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      padding: 32px 40px 24px 42px;
      box-sizing: border-box;
      border-right: 3px solid #222c40;
      position: relative;
      cursor: pointer;
      gap: 2px;
    }
    #current-flexrow {
      display: flex;
      flex-direction: row;
      align-items: flex-start;
      width: 100%;
      gap: 32px;
    }
    .current-temp-icon {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 144px;
      margin-right: 14px;
    }
    .temp {
      font-size: 6.3rem;
      font-weight: 600;
      color: #fff;
      line-height: 1;
      text-shadow: 0 1px 14px #222;
      margin-bottom: 0.03em;
      margin-top: 5px;
    }
    .weather-row {
      display: flex;
      align-items: center;
      gap: 13px;
      font-size: 2.6rem;
      font-weight: 400;
      color: #fff;
      margin-top: 5px;
      margin-bottom: 7px;
    }
    .weather-row img {
      width: 58px; height: 58px; margin-right: 4px;
    }
    .current-cols {
      flex: 1;
      display: flex;
      flex-direction: row;
      gap: 36px;
      margin-left: 5px;
      margin-top: 2px;
    }
    .col {
      display: flex;
      flex-direction: column;
      gap: 11px;
      font-size: 1.35rem;
      color: #c0d2ed;
      min-width: 180px;
      max-width: 230px;
      line-height: 1.38;
    }
    .rain-row {
      font-size: 1.38rem;
      color: #62c9fa;
      font-weight: 700;
      margin-top: 9px;
      margin-bottom: 4px;
    }
    .today-row {
      font-size: 1.33rem;
      color: #ffedbc;
      font-weight: 600;
      margin-bottom: 7px;
      margin-top: 7px;
    }
    #todays-advice {
      background: #253e62;
      color: #ffd25a;
      border-radius: 10px;
      font-size: 1.42rem;
      margin-top: 20px;
      margin-bottom: 3px;
      padding: 22px 24px 22px 26px;
      font-weight: 600;
      box-shadow: 0 2px 11px #0002;
      line-height: 1.48;
      letter-spacing: 0.01em;
      display: block;
      min-height: 54px;
      width: 100%;
      overflow-wrap: break-word;
      word-break: break-word;
    }
    #forecast-block {
      flex: 1;
      display: flex;
      align-items: flex-start;
      height: 100%;
      padding: 0 32px;
      overflow-x: auto;
      background: #181e2a;
      gap: 36px;
    }
    .forecast-card {
      min-width: 330px;
      max-width: 350px;
      height: 410px;
      background: #232f47;
      border-radius: 28px;
      padding: 42px 28px 30px 36px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      box-shadow: 0 1px 12px #0004;
      color: #fff;
      margin: 0 9px;
      justify-content: flex-start;
      cursor: pointer;
      transition: box-shadow 0.13s;
      position: relative;
    }
    .forecast-card:hover {
      box-shadow: 0 14px 42px #0008;
      background: #27334f;
    }
    .forecast-card .day {
      font-weight: bold;
      font-size: 2.4rem;
      margin-bottom: 16px;
      color: #fff;
      letter-spacing: 0.02em;
    }
    .forecast-card .icon {
      font-size: 7.5rem;
      margin-bottom: 10px;
      width: 190px;
      height: 190px;
      display: block;
      align-self: center;
    }
    .forecast-card .desc {
      font-size: 1.74rem;
      color: #c0d2ed;
      margin-bottom: 8px;
      min-height: 42px;
      line-height: 1.2;
      white-space: pre-line;
      font-weight: 400;
    }
    .forecast-card .lowhigh, .forecast-card .gust, .forecast-card .precip, .forecast-card .extra {
      width: 100%;
      display: block;
    }
    .forecast-card .lowhigh {
      font-size: 1.66rem;
      font-weight: 700;
      color: #fff;
      margin-bottom: 0.15em;
      margin-top: 0.05em;
    }
    .forecast-card .gust {
      font-size: 1.43rem;
      color: #aad7ff;
      margin-bottom: 0.10em;
      font-weight: 400;
    }
    .forecast-card .precip {
      font-size: 1.41rem;
      color: #96e8ff;
      margin-bottom: 0.11em;
      font-weight: 400;
    }
    .forecast-card .extra {
      font-size: 1.25rem;
      color: #b7e7c5;
      margin-top: 5px;
      font-weight: 600;
    }
    #popup-bg {
      position: fixed;
      z-index: 99999;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(20, 30, 50, 0.86);
      display: none;
      align-items: center;
      justify-content: center;
    }
    #popup-content {
      background: #232f47;
      border-radius: 18px;
      padding: 36px 54px;
      color: #fff;
      font-size: 1.6rem;
      font-weight: 500;
      max-width: 480px;
      width: 92vw;
      box-shadow: 0 12px 40px #000c;
      line-height: 1.36;
      position: relative;
      text-align: center;
    }
    #popup-close {
      position: absolute;
      top: 10px; right: 22px;
      font-size: 2.3rem;
      color: #aad7ff;
      cursor: pointer;
      background: none;
      border: none;
    }
    #popup-title {
      font-size: 1.15em;
      font-weight: bold;
      margin-bottom: 10px;
    }
    #popup-summary, #popup-lowhigh, #popup-extra {
      margin-bottom: 8px;
    }
    #popup-ai {
      margin-top: 10px;
      font-size: 1.13rem;
      color: #fee680;
    }
    #popup-hist {
      margin-top: 14px;
      color: #aad7ff;
      font-size: 1.03rem;
      line-height: 1.22;
    }
    @media (max-width: 1300px) {
      #main-container { width: 99vw !important; }
      #forecast-block { gap: 17px; }
      .forecast-card { min-width: 190px; max-width: 200px; height: 250px; padding: 14px 6px 6px 15px;}
    }
  </style>
</head>
<body>
  <div id="main-container">
    <div id="current-block" tabindex="0">
      <div id="current-flexrow">
        <div class="current-temp-icon">
          <div class="temp" id="temp">--°C</div>
          <div class="weather-row" id="weather-row">
            <img id="cur-icon" src="" style="display:none;" alt="">
            <span id="weather-text">Loading…</span>
          </div>
        </div>
        <div class="current-cols">
          <div class="col" id="details-col"></div>
          <div class="col">
            <div class="rain-row" id="rain-row"></div>
            <div class="today-row" id="today-row"></div>
          </div>
        </div>
      </div>
      <div id="todays-advice">Loading today’s AI advice…</div>
    </div>
    <div id="forecast-block"></div>
  </div>

  <!-- Popup for forecast details & AI advice -->
  <div id="popup-bg">
    <div id="popup-content">
      <button id="popup-close" onclick="closePopup()">&times;</button>
      <div id="popup-title"></div>
      <div id="popup-summary"></div>
      <div id="popup-lowhigh"></div>
      <div id="popup-extra"></div>
      <div id="popup-ai"></div>
      <div id="popup-hist"></div>
    </div>
  </div>

  <script>
    // --- Non-repeating, season- and weather-aware, no "check alarms", big advice library ---
    function agoraAiAdvice(opts) {
      // Direct, non-tech, never repeats
      const adviceWeather = [
        { cond: d => d.precip >= 20, msg: "Heavy rain expected. Move cows off low ground and clear drains before milking." },
        { cond: d => d.precip > 10, msg: "Rain is forecast. Add woodchips at gateways and stand-off pads." },
        { cond: d => d.precip > 4, msg: "Showers expected. Hose the yard after milking to keep it safe and clean." },
        { cond: d => d.temp >= 28, msg: "Very hot day. Delay yarding and ensure extra water in troughs." },
        { cond: d => d.temp > 24 && d.humidity > 70, msg: "Warm, humid weather. Begin zinc dosing for facial eczema." },
        { cond: d => d.temp < 5, msg: "Cold snap. Give calves extra bedding and close sheds overnight." },
        { cond: d => d.temp > 20 && d.precip < 2 && d.month >= 1 && d.month <= 3, msg: "Hot, dry conditions. Rotate paddocks early and check all troughs." },
        { cond: d => d.gust > 60, msg: "Strong winds. Secure loose gates and check fence lines." },
        { cond: d => d.temp < 8 && d.month == 8, msg: "August is cold and wet. Use a footbath for lameness at the shed exit." },
        { cond: d => d.temp > 18 && d.precip > 6, msg: "Lush pasture after rain. Offer hay to prevent bloat." },
        { cond: d => d.temp < 10 && d.month == 7, msg: "July is cold. Add windbreaks and dry bedding for calves." }
      ];
      const adviceSeasonal = [
        { cond: d => d.month == 8, msg: "August: Calving time. Have iodine, towels, and colostrum feeders ready for new calves." },
        { cond: d => d.month == 9, msg: "September: Top up bedding in shelters and check fences in calving paddocks." },
        { cond: d => d.month == 10, msg: "October: Plan ahead for mating. Order tail paint and check bull health." },
        { cond: d => d.month == 11, msg: "November: Magnesium supplements reduce risk of grass staggers in herd." },
        { cond: d => d.month == 12, msg: "December: Keep troughs clear of algae and check water every day." },
        { cond: d => d.month == 1, msg: "January: Move shade cloths into position and check tank ballcocks." },
        { cond: d => d.month == 2, msg: "February: Fuel up generator and review storm procedures." },
        { cond: d => d.month == 3, msg: "March: Patch silage stack covers before heavy rain." },
        { cond: d => d.month == 4, msg: "April: Book winter feed and check all bale covers." },
        { cond: d => d.month == 5, msg: "May: Service effluent pump and back-up generator now." },
        { cond: d => d.month == 6, msg: "June: Top up woodchips, check all heaters before the coldest nights." },
        { cond: d => d.month == 7, msg: "July: Disinfect calf pens and trailers, calving is near." }
      ];
      const adviceEveryday = [
        "Check paper towels and soap in the wash-up area.",
        "Scrape the pit floor and rinse down after milking.",
        "Remove stones and grass from tanker track entry.",
        "Sweep and salt slippery steps at plant room.",
        "Check gloves and boots are well stocked.",
        "Clean filter at shed water inlet.",
        "Inspect chemical hoses for leaks.",
        "Disinfect calf feeders and hang to dry.",
        "Remove loose twine from the yard.",
        "Spray fence line weeds if fine.",
        "Move empty drums to recycling.",
        "Hang clusters properly after milking.",
        "Sweep feed room and remove empty bags.",
        "Hose the exit race for a clean walk-off.",
        "Check meal auger for blockages.",
        "Close silo doors and sweep out old feed.",
        "Walk the main race and fill deep holes.",
        "Scrub cow brushes to keep them clean.",
        "Remove old nests and cobwebs in the dairy.",
        "Test tap water temp before cleaning.",
        "Count calves, check feeding mobs.",
        "Rinse boots before leaving shed.",
        "Top up lime in calf pens for dry bedding.",
        "Brush cobwebs in tea room and dairy.",
        "Tidy up tea room after smoko.",
        "Walk pasture to note covers and resting areas."
      ];
      // Extra contextual insertions
      function pastureOutlook(d) {
        if (d.temp >= 20 && d.precip >= 5) return "Pasture growth outlook: Excellent. Expect rapid pasture growth in coming days.";
        if (d.temp < 10 && d.precip < 2) return "Pasture growth outlook: Slow. Low soil temps and low rainfall slowing growth.";
        return "";
      }
      function dewRisk(d) {
        if (d.humidity > 85 && d.temp > 10) return "High dew risk: Allow extra time for paddocks to dry before mowing or letting cows out.";
        return "";
      }
      const d = {
        month: (opts.dateISO ? new Date(opts.dateISO).getMonth() : new Date().getMonth()) + 1,
        temp: opts.temp,
        humidity: opts.humidity,
        precip: opts.precip,
        gust: opts.gust || 0
      };
      // Day hash for practical tips
      const hashDay = Math.abs((new Date(opts.dateISO || Date.now())).getDate() +
        ((new Date(opts.dateISO || Date.now())).getMonth() + 1) * 37);
      let advs = [];
      for (let adv of adviceWeather) if (adv.cond(d)) advs.push(adv.msg);
      for (let adv of adviceSeasonal) if (adv.cond(d)) advs.push(adv.msg);
      let rotIndex = hashDay % adviceEveryday.length;
      advs.push(adviceEveryday[rotIndex]);
      if (advs.length < 2) advs.push(adviceEveryday[(rotIndex+5)%adviceEveryday.length]);
      advs = advs.filter((v, i, arr) => arr.indexOf(v) === i).slice(0, 2);
      // Insert outlooks as final tip if relevant and space available
      let outlook = pastureOutlook(d) || dewRisk(d);
      if (outlook) advs.push(`<span style="color:#b7e7c5;font-size:1.12em;">${outlook}</span>`);
      return advs.map(txt => `<div>${txt}</div>`).join('');
    }
    function iconUrl(icon) {
      if (!icon) return '';
      return `https://cdn.aerisapi.com/wxblox/icons/${icon}`;
    }
    function dayOfWeek(dateISO) {
      return new Date(dateISO).toLocaleDateString('en-NZ', { weekday: 'short' });
    }
    function capitalize(txt) {
      return (txt || '').charAt(0).toUpperCase() + (txt || '').slice(1);
    }

    let rainHistory = { today: 0, week: 0, month: 0, year: 0 };

    // Current box population (horizontal layout)
    fetch('https://data.api.xweather.com/conditions/pws_pukerimu?format=json&plimit=1&filter=1min&client_id=U8feQfLlcEfcXDfsWZs4C&client_secret=HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq')
      .then(r => r.json())
      .then(json => {
        if (!json.success) throw new Error('No current conditions');
        const p = json.response[0].periods[0];
        document.getElementById('temp').textContent = 
          (typeof p.tempC === 'number') ? `${Math.round(p.tempC)}°C` : '--°C';
        const icon = p.icon || '';
        const icElem = document.getElementById('cur-icon');
        if (icon) {
          icElem.src = iconUrl(icon);
          icElem.style.display = '';
        } else {
          icElem.style.display = 'none';
        }
        document.getElementById('weather-text').textContent = capitalize(p.weather) || '--';

        document.getElementById('details-col').innerHTML =
          `<div><b>Feels like:</b> ${p.feelslikeC !== null && p.feelslikeC !== undefined ? Math.round(p.feelslikeC) + '°C' : 'NA'}</div>
           <div><b>Humidity:</b> ${p.humidity !== null && p.humidity !== undefined ? p.humidity + '%' : 'NA'}</div>
           <div><b>Wind:</b> ${p.windSpeedKPH !== null && p.windSpeedKPH !== undefined ? Math.round(p.windSpeedKPH) + ' km/h' : 'NA'}</div>
           <div><b>Gusts:</b> ${p.windGustKPH !== null && p.windGustKPH !== undefined ? Math.round(p.windGustKPH) + ' km/h' : 'NA'}</div>
           <div><b>Pressure:</b> ${p.pressureMB !== null && p.pressureMB !== undefined ? p.pressureMB + ' hPa' : 'NA'}</div>`;

        // Rainfall today (observed so far) - always single-line
        const todayRain = (p.precipMM !== null && p.precipMM !== undefined) ? p.precipMM : 0;
        document.getElementById('rain-row').innerHTML = `<b>Rainfall so far:</b> ${todayRain} mm`;
        rainHistory.today = Number(todayRain) || 0;

        document.getElementById('todays-advice').innerHTML = agoraAiAdvice({
          temp: p.tempC,
          humidity: p.humidity,
          gust: p.windGustKPH,
          precip: p.precipMM,
          dateISO: p.dateTimeISO
        });

        document.getElementById('current-block').onclick = () => openPopup({
          title: "Current Conditions",
          summary: "",
          lowhigh: "",
          extra: `<b>Temp:</b> ${Math.round(p.tempC)}°C<br>
                  <b>Feels like:</b> ${p.feelslikeC !== null ? Math.round(p.feelslikeC) + '°C' : 'NA'}<br>
                  <b>Wind:</b> ${Math.round(p.windSpeedKPH || 0)} km/h (${p.windDir || ''})<br>
                  <b>Humidity:</b> ${p.humidity || 'NA'}%<br>
                  <b>Rainfall:</b> ${p.precipMM || 0} mm today`,
          ai: agoraAiAdvice({
            temp: p.tempC,
            humidity: p.humidity,
            gust: p.windGustKPH,
            precip: p.precipMM,
            dateISO: p.dateTimeISO
          }),
          hist: `<strong>Rain history:</strong><br>
                 Today: ${p.precipMM || 0} mm<br>
                 This week: ${rainHistory.week} mm<br>
                 This month: ${rainHistory.month} mm<br>
                 This year: ${rainHistory.year} mm`
        });
      });

    // Forecast: only 5 days, cards scaled up with 3x icon size, bold, extra info
    fetch('https://data.api.xweather.com/forecasts/pws_pukerimu?format=json&plimit=8&fields=periods.timestamp,periods.dateTimeISO,periods.tempC,periods.weather,periods.icon,periods.maxTempC,periods.minTempC,periods.humidity,periods.precipMM,periods.windSpeedKPH,periods.windGustKPH,periods.summary&client_id=U8feQfLlcEfcXDfsWZs4C&client_secret=HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq')
      .then(r => r.json())
      .then(json => {
        if (!json.success) throw new Error('No forecast');
        const fc = json.response[0].periods || [];
        const fcDom = document.getElementById('forecast-block');
        fcDom.innerHTML = "";
        // Rain history
        const now = new Date();
        const weekAgo = new Date(now); weekAgo.setDate(now.getDate() - 6);
        const monthAgo = new Date(now); monthAgo.setMonth(now.getMonth() - 1);
        const yearAgo = new Date(now); yearAgo.setFullYear(now.getFullYear() - 1);
        let weekRain = 0, monthRain = 0, yearRain = 0;
        for (let period of fc) {
          let d = new Date(period.dateTimeISO);
          if (d >= weekAgo) weekRain += Number(period.precipMM) || 0;
          if (d >= monthAgo) monthRain += Number(period.precipMM) || 0;
          if (d >= yearAgo) yearRain += Number(period.precipMM) || 0;
        }
        rainHistory.week = Math.round(weekRain);
        rainHistory.month = Math.round(monthRain);
        rainHistory.year = Math.round(yearRain);

        // Add today's hi/lo/expected
        if (fc.length > 0) {
          const todayFc = fc[0];
          document.getElementById('today-row').innerHTML =
            `<b>Today:</b> High ${Math.round(todayFc.maxTempC)}°C, Low ${Math.round(todayFc.minTempC)}°C<br>
             <b>Expected rain:</b> ${todayFc.precipMM || 0} mm`;
        }
        // Show only next 5 forecast days, cards bigger and more prominent
        for (let i = 1; i < fc.length && i <= 5; ++i) {
          const p = fc[i];
          // Pasture and dew outlook per day if relevant
          let dayOutlook = '';
          if (p.tempC >= 20 && p.precipMM >= 5) dayOutlook = "<div class='extra'>Pasture growth: Rapid</div>";
          else if (p.tempC < 10 && p.precipMM < 2) dayOutlook = "<div class='extra'>Pasture growth: Slow</div>";
          else if (p.humidity > 85 && p.tempC > 10) dayOutlook = "<div class='extra'>High dew risk</div>";
          fcDom.innerHTML += `
            <div class="forecast-card" tabindex="0" onclick="openPopup({
                title: '${dayOfWeek(p.dateTimeISO)}',
                summary: '',
                lowhigh: 'High: ${Math.round(p.maxTempC)}°C<br>Low: ${Math.round(p.minTempC)}°C',
                extra: 'Gusts: ${Math.round(p.windGustKPH || 0)} km/h<br>Precip: ${p.precipMM || 0} mm',
                ai: \`${agoraAiAdvice({
                  temp: p.tempC || p.maxTempC,
                  humidity: p.humidity,
                  gust: p.windGustKPH,
                  precip: p.precipMM,
                  dateISO: p.dateTimeISO
                })}\`
              })">
              <div class="day">${dayOfWeek(p.dateTimeISO)}</div>
              <img class="icon" src="${iconUrl(p.icon)}" alt="" width="190" height="190">
              <div class="desc">${capitalize(p.weather || '')}</div>
              <div class="lowhigh">High: ${Math.round(p.maxTempC)}°C<br>Low: ${Math.round(p.minTempC)}°C</div>
              <div class="gust">Gusts: ${Math.round(p.windGustKPH || 0)} km/h</div>
              <div class="precip">Precip: ${p.precipMM || 0} mm</div>
              ${dayOutlook}
            </div>
          `;
        }
      });

    function openPopup(opts) {
      document.getElementById('popup-title').textContent = opts.title || "";
      document.getElementById('popup-summary').textContent = opts.summary || "";
      document.getElementById('popup-lowhigh').innerHTML = opts.lowhigh || "";
      document.getElementById('popup-extra').innerHTML = opts.extra || "";
      document.getElementById('popup-ai').innerHTML = opts.ai || "";
      document.getElementById('popup-hist').innerHTML = opts.hist || "";
      document.getElementById('popup-bg').style.display = 'flex';
    }
    function closePopup() {
      document.getElementById('popup-bg').style.display = 'none';
    }
    document.getElementById('popup-bg').onclick = (e) => { if (e.target === e.currentTarget) closePopup(); }
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closePopup(); });
  </script>
</body>
</html>