<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Agora Weather Widget</title>
  <meta name="viewport" content="width=1800">
  <style>
    html, body {
      background: #181e2a;
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      color: #fff;
      font-family: 'Segoe UI', Arial, sans-serif;
    }
    #main-container {
      width: 100vw;
      max-width: 1800px;
      min-width: 1000px;
      height: 550px;
      margin: 0 auto;
      display: flex;
      align-items: flex-start;
      background: #181e2a;
      box-shadow: 0 2px 24px #0008;
      border-radius: 18px;
      overflow: hidden;
    }
    #current-block {
      width: 680px;
      min-width: 540px;
      max-width: 860px;
      height: 100%;
      background: #222c40;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      padding: 32px 36px 28px 38px;
      box-sizing: border-box;
      border-right: 3px solid #222c40;
      position: relative;
      cursor: pointer;
      gap: 2px;
    }
    #current-flexrow {
      display: flex;
      flex-direction: row;
      align-items: flex-start;
      width: 100%;
      gap: 28px;
    }
    .current-temp-icon {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 130px;
      margin-right: 12px;
    }
    .temp {
      font-size: 6.2rem;
      font-weight: 700;
      color: #fff;
      line-height: 1;
      text-shadow: 0 1px 14px #222;
      margin-bottom: 0.03em;
      margin-top: 7px;
    }
    .weather-row {
      display: flex;
      align-items: center;
      gap: 11px;
      font-size: 2.7rem;
      font-weight: 500;
      color: #fff;
      margin-top: 8px;
      margin-bottom: 10px;
    }
    .weather-row img {
      width: 72px; height: 72px; margin-right: 4px;
    }
    .current-cols {
      flex: 1;
      display: flex;
      flex-direction: row;
      gap: 30px;
      margin-left: 5px;
      margin-top: 2px;
    }
    .col {
      display: flex;
      flex-direction: column;
      gap: 13px;
      font-size: 1.48rem;
      color: #c0d2ed;
      min-width: 190px;
      max-width: 230px;
      line-height: 1.38;
    }
    .rain-row {
      font-size: 1.52rem;
      color: #62c9fa;
      font-weight: 700;
      margin-top: 7px;
      margin-bottom: 4px;
    }
    .today-row {
      font-size: 1.45rem;
      color: #ffedbc;
      font-weight: 600;
      margin-bottom: 8px;
      margin-top: 8px;
    }
    #todays-advice {
      background: #253e62;
      color: #ffd25a;
      border-radius: 11px;
      font-size: 1.55rem;
      margin-top: 28px;
      margin-bottom: 4px;
      padding: 24px 26px 24px 26px;
      font-weight: 600;
      box-shadow: 0 2px 13px #0002;
      line-height: 1.5;
      letter-spacing: 0.01em;
      display: block;
      min-height: 50px;
      width: 100%;
      overflow-wrap: break-word;
      word-break: break-word;
    }
    #forecast-block {
      flex: 1;
      display: flex;
      align-items: flex-start;
      height: 100%;
      padding: 0 32px;
      overflow-x: auto;
      background: #181e2a;
      gap: 34px;
    }
    .forecast-card {
      min-width: 350px;
      max-width: 370px;
      height: 420px;
      background: #232f47;
      border-radius: 28px;
      padding: 44px 28px 32px 36px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      box-shadow: 0 1px 12px #0004;
      color: #fff;
      margin: 0 9px;
      justify-content: flex-start;
      cursor: pointer;
      transition: box-shadow 0.13s;
      position: relative;
    }
    .forecast-card:hover {
      box-shadow: 0 14px 42px #0008;
      background: #27334f;
    }
    .forecast-card .day {
      font-weight: bold;
      font-size: 2.6rem;
      margin-bottom: 18px;
      color: #fff;
      letter-spacing: 0.02em;
    }
    .forecast-card .icon {
      font-size: 8.1rem;
      margin-bottom: 13px;
      width: 215px;
      height: 215px;
      display: block;
      align-self: center;
    }
    .forecast-card .desc {
      font-size: 1.83rem;
      color: #c0d2ed;
      margin-bottom: 10px;
      min-height: 40px;
      line-height: 1.2;
      white-space: pre-line;
      font-weight: 400;
    }
    .forecast-card .lowhigh, .forecast-card .gust, .forecast-card .precip, .forecast-card .extra {
      width: 100%;
      display: block;
    }
    .forecast-card .lowhigh {
      font-size: 1.77rem;
      font-weight: 700;
      color: #fff;
      margin-bottom: 0.15em;
      margin-top: 0.05em;
    }
    .forecast-card .gust {
      font-size: 1.49rem;
      color: #aad7ff;
      margin-bottom: 0.12em;
      font-weight: 400;
    }
    .forecast-card .precip {
      font-size: 1.48rem;
      color: #96e8ff;
      margin-bottom: 0.12em;
      font-weight: 400;
    }
    .forecast-card .extra {
      font-size: 1.32rem;
      color: #b7e7c5;
      margin-top: 7px;
      font-weight: 600;
    }
    #popup-bg {
      position: fixed;
      z-index: 99999;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(20, 30, 50, 0.86);
      display: none;
      align-items: center;
      justify-content: center;
    }
    #popup-content {
      background: #232f47;
      border-radius: 18px;
      padding: 36px 54px;
      color: #fff;
      font-size: 1.6rem;
      font-weight: 500;
      max-width: 480px;
      width: 92vw;
      box-shadow: 0 12px 40px #000c;
      line-height: 1.36;
      position: relative;
      text-align: center;
    }
    #popup-close {
      position: absolute;
      top: 10px; right: 22px;
      font-size: 2.3rem;
      color: #aad7ff;
      cursor: pointer;
      background: none;
      border: none;
    }
    #popup-title {
      font-size: 1.15em;
      font-weight: bold;
      margin-bottom: 10px;
    }
    #popup-summary, #popup-lowhigh, #popup-extra {
      margin-bottom: 8px;
    }
    #popup-ai {
      margin-top: 10px;
      font-size: 1.13rem;
      color: #fee680;
    }
    #popup-hist {
      margin-top: 14px;
      color: #aad7ff;
      font-size: 1.03rem;
      line-height: 1.22;
    }
    @media (max-width: 1500px) {
      #main-container { width: 99vw !important; min-width: 900px;}
      #forecast-block { gap: 15px; }
      .forecast-card { min-width: 180px; max-width: 200px; height: 230px; padding: 16px 10px 10px 18px;}
      .forecast-card .icon {width: 80px;height:80px;}
    }
  </style>
</head>
<body>
  <div id="main-container">
    <div id="current-block" tabindex="0">
      <div id="current-flexrow">
        <div class="current-temp-icon">
          <div class="temp" id="temp">--°C</div>
          <div class="weather-row" id="weather-row">
            <img id="cur-icon" src="" style="display:none;" alt="">
            <span id="weather-text">Loading…</span>
          </div>
        </div>
        <div class="current-cols">
          <div class="col" id="details-col"></div>
          <div class="col">
            <div class="rain-row" id="rain-row"></div>
            <div class="today-row" id="today-row"></div>
          </div>
        </div>
      </div>
      <div id="todays-advice">Loading today’s AI advice…</div>
    </div>
    <div id="forecast-block"></div>
  </div>

  <!-- Popup for forecast details & AI advice -->
  <div id="popup-bg">
    <div id="popup-content">
      <button id="popup-close" onclick="closePopup()">&times;</button>
      <div id="popup-title"></div>
      <div id="popup-summary"></div>
      <div id="popup-lowhigh"></div>
      <div id="popup-extra"></div>
      <div id="popup-ai"></div>
      <div id="popup-hist"></div>
    </div>
  </div>

  <script>
    // Utility: weather icons for Open-Meteo code
    function openMeteoIcon(code, is_day) {
      const icons = {
        0: "clear-day", 1: "mainly-clear", 2: "partly-cloudy", 3: "cloudy",
        45: "fog", 48: "depositing-rime-fog", 51: "drizzle", 53: "drizzle", 55: "drizzle",
        56: "freezing-drizzle", 57: "freezing-drizzle",
        61: "rain", 63: "rain", 65: "rain", 66: "freezing-rain", 67: "freezing-rain",
        71: "snow", 73: "snow", 75: "snow", 77: "snow-grains",
        80: "rain-showers", 81: "rain-showers", 82: "rain-showers",
        85: "snow-showers", 86: "snow-showers",
        95: "thunderstorm", 96: "thunderstorm-hail", 99: "thunderstorm-hail"
      };
      let name = icons[code] || "unknown";
      if (name === "clear-day" && !is_day) name = "clear-night";
      return `https://cdn.aerisapi.com/wxblox/icons/${name}.png`;
    }

    // --- AI ADVICE LIBRARY, Weather/season aware, non-repeating, no hardware refs ---
    function agoraAiAdvice(opts, dayIndex=0) {
      // Giant advice libraries for dairy NZ
      const adviceWeather = [
        { cond: d => d.precip >= 20, msg: "Heavy rain: Move cows off low paddocks and clear drains before milking." },
        { cond: d => d.precip > 10, msg: "Steady rain: Lay woodchips at gateways and around troughs." },
        { cond: d => d.precip > 4, msg: "Showers: Hose mud off the yard after milking." },
        { cond: d => d.temp >= 28, msg: "Very hot: Yard cows later and check all troughs for water flow." },
        { cond: d => d.temp > 24 && d.humidity > 70, msg: "Warm & humid: Begin zinc dosing for facial eczema." },
        { cond: d => d.temp < 5, msg: "Cold snap: Extra bedding for calves and close sheds overnight." },
        { cond: d => d.temp > 20 && d.precip < 2 && d.month >= 1 && d.month <= 3, msg: "Hot & dry: Rotate paddocks early and scrub troughs clean." },
        { cond: d => d.gust > 60, msg: "Windy: Secure loose gates and check fence lines." },
        { cond: d => d.temp < 8 && d.month == 8, msg: "August cold: Use footbath for lameness at shed exit." },
        { cond: d => d.temp > 18 && d.precip > 6, msg: "Lush after rain: Offer hay to reduce bloat risk." },
        { cond: d => d.temp < 10 && d.month == 7, msg: "July cold: Add windbreaks and dry bedding for calves." }
      ];
      const adviceSeasonal = [
        { cond: d => d.month == 8, msg: "August: Have iodine, towels, and colostrum ready for calving." },
        { cond: d => d.month == 9, msg: "September: Top up bedding in calving shelters, check fences." },
        { cond: d => d.month == 10, msg: "October: Order tail paint and check bull health for mating." },
        { cond: d => d.month == 11, msg: "November: Magnesium supplements help reduce grass staggers risk." },
        { cond: d => d.month == 12, msg: "December: Clean troughs daily and check water supplies." },
        { cond: d => d.month == 1, msg: "January: Move shade cloths and check tank ballcocks." },
        { cond: d => d.month == 2, msg: "February: Fuel generator and review storm plans." },
        { cond: d => d.month == 3, msg: "March: Patch silage stack covers and secure feed." },
        { cond: d => d.month == 4, msg: "April: Book winter feed and check all bale covers." },
        { cond: d => d.month == 5, msg: "May: Service effluent pump and tidy up drainage areas." },
        { cond: d => d.month == 6, msg: "June: Top up woodchips, check all heaters." },
        { cond: d => d.month == 7, msg: "July: Disinfect calf pens and gear—calving soon." }
      ];
      // Massive everyday advice, plenty of unique entries:
      const adviceEveryday = [
        "Top up paper towels in the staff wash-up area.",
        "Scrape and rinse pit floor after milking.",
        "Remove stones/grass from tanker track entry.",
        "Sweep plant room steps for safer footing.",
        "Check glove and boot supplies for next milking.",
        "Clean water inlet filter.",
        "Inspect chemical hoses for leaks.",
        "Disinfect calf feeders and hang up to dry.",
        "Remove all twine from the yard.",
        "Spray fence line weeds on fine days.",
        "Move empty chemical drums to recycling.",
        "Hang clusters on rack after milking.",
        "Sweep feed room and remove old meal bags.",
        "Hose down the exit race.",
        "Check auger/meal system for blockages.",
        "Sweep out tea room after smoko.",
        "Scrub cow brushes clean.",
        "Remove old nests and cobwebs.",
        "Count calves, check mobs/feed.",
        "Rinse boots before leaving shed.",
        "Top up lime for dry calf bedding.",
        "Tidy up tools on workbench.",
        "Brush cobwebs in dairy/tea room.",
        "Walk pasture and note resting covers.",
        "Check silo doors and sweep out feed.",
        "Walk main race and fill holes.",
        "Record rainfall/notes in diary.",
        "Clean test bucket and milkers' aprons.",
        "Remove debris from pump inlets.",
        "Hose and tidy up teat sprayer arms.",
        "Replace batteries in torch/clock.",
        "Update roster in tea room.",
        "Blow dust off sensors, cameras, and lights.",
        "Salt any icy spots on yards or driveways.",
        "Re-check all tank and gate valves."
      ];
      // Context insertions
      function pastureOutlook(d) {
        if (d.temp >= 20 && d.precip >= 5) return "Pasture growth: Excellent—expect a big jump in covers.";
        if (d.temp < 10 && d.precip < 2) return "Pasture growth: Slow—soil temps and moisture are low.";
        return "";
      }
      function dewRisk(d) {
        if (d.humidity > 85 && d.temp > 10) return "High dew risk: Allow time for paddocks to dry before grazing/mowing.";
        return "";
      }
      // Build advice for today or dayIndex offset
      const d = {
        month: (opts.dateISO ? new Date(opts.dateISO).getMonth() : new Date().getMonth()) + 1,
        temp: opts.temp,
        humidity: opts.humidity,
        precip: opts.precip,
        gust: opts.gust || 0
      };
      // Day hash for rotation
      let rotIndex = (Math.abs((new Date(opts.dateISO || Date.now())).getDate() +
        ((new Date(opts.dateISO || Date.now())).getMonth() + 1) * 31 + dayIndex * 17)) % adviceEveryday.length;
      // Pick weather, then seasonal, then unique everyday
      let advs = [];
      for (let adv of adviceWeather) if (adv.cond(d)) advs.push(adv.msg);
      for (let adv of adviceSeasonal) if (adv.cond(d)) advs.push(adv.msg);
      // Rotate unique daily tips across all visible days so no repeat!
      advs.push(adviceEveryday[(rotIndex + dayIndex * 5) % adviceEveryday.length]);
      if (advs.length < 2) advs.push(adviceEveryday[(rotIndex+7 + dayIndex*3)%adviceEveryday.length]);
      advs = advs.filter((v, i, arr) => arr.indexOf(v) === i).slice(0, 2);
      // Insert outlooks as final tip if relevant
      let outlook = pastureOutlook(d) || dewRisk(d);
      if (outlook) advs.push(`<span style="color:#b7e7c5;font-size:1.05em;">${outlook}</span>`);
      return advs.map(txt => `<div>${txt}</div>`).join('');
    }

    function capitalize(txt) {
      return (txt || '').charAt(0).toUpperCase() + (txt || '').slice(1);
    }
    function dayOfWeek(dateISO) {
      return new Date(dateISO).toLocaleDateString('en-NZ', { weekday: 'short' });
    }

    // Current weather population (using Open-Meteo, NZ latitude/longitude for example)
    // Replace latitude/longitude for your site
    const LAT = -37.85, LON = 175.68; // Example: Waikato
    let rainHistory = { today: 0, week: 0, month: 0, year: 0 };
    let forecastPeriods = [];

    // Load both current and forecast
    Promise.all([
      fetch(`https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&current_weather=true&hourly=temperature_2m,precipitation,weathercode,relative_humidity_2m,windspeed_10m,windgusts_10m,surface_pressure&forecast_days=7&timezone=Pacific%2FAuckland`).then(r=>r.json()),
      fetch(`https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,weathercode,windgusts_10m&forecast_days=7&timezone=Pacific%2FAuckland`).then(r=>r.json())
    ]).then(([cur, fc]) => {
      // --- Current box ---
      const p = cur.current_weather || {};
      const curIconCode = cur.current_weather.weathercode;
      // Hourly humidity/precip at current hour
      let nowIdx = cur.hourly && cur.hourly.time ?
        cur.hourly.time.findIndex(t => new Date(t).getHours() === new Date().getHours()) : 0;
      let humidity = cur.hourly && cur.hourly.relative_humidity_2m ? cur.hourly.relative_humidity_2m[nowIdx] : null;
      let gust = cur.hourly && cur.hourly.windgusts_10m ? cur.hourly.windgusts_10m[nowIdx] : null;
      let precipToday = 0;
      let todayISO = (cur.hourly && cur.hourly.time && cur.hourly.time.length) ? cur.hourly.time[0].slice(0,10) : "";
      if(cur.hourly && cur.hourly.time){
        let day = todayISO;
        for(let i=0;i<cur.hourly.time.length;i++) {
          if(cur.hourly.time[i].startsWith(day)) precipToday += cur.hourly.precipitation[i]||0;
        }
      }
      // Details
      document.getElementById('temp').textContent = (p.temperature !== undefined) ? `${Math.round(p.temperature)}°C` : '--°C';
      const icElem = document.getElementById('cur-icon');
      icElem.src = openMeteoIcon(curIconCode, p.is_day);
      icElem.style.display = '';
      document.getElementById('weather-text').textContent = capitalize(p.weathercode ? "" : "Loading...");

      document.getElementById('details-col').innerHTML =
        `<div><b>Feels like:</b> ${p.apparent_temperature !== undefined ? Math.round(p.apparent_temperature) + '°C' : 'NA'}</div>
         <div><b>Humidity:</b> ${humidity !== null && humidity !== undefined ? humidity + '%' : 'NA'}</div>
         <div><b>Wind:</b> ${p.windspeed !== undefined ? Math.round(p.windspeed) + ' km/h' : 'NA'}</div>
         <div><b>Gusts:</b> ${gust !== null && gust !== undefined ? Math.round(gust) + ' km/h' : 'NA'}</div>
         <div><b>Pressure:</b> ${cur.hourly && cur.hourly.surface_pressure ? Math.round(cur.hourly.surface_pressure[nowIdx]) + ' hPa' : 'NA'}</div>`;

      document.getElementById('rain-row').innerHTML = `<b>Rainfall so far:</b> ${precipToday.toFixed(1)} mm`;
      document.getElementById('today-row').innerHTML =
        `<b>Today:</b> High ${Math.round(fc.daily.temperature_2m_max[0])}°C, Low ${Math.round(fc.daily.temperature_2m_min[0])}°C<br>
         <b>Expected rain:</b> ${fc.daily.precipitation_sum[0].toFixed(1)} mm`;

      document.getElementById('todays-advice').innerHTML = agoraAiAdvice({
        temp: p.temperature,
        humidity: humidity,
        gust: gust,
        precip: fc.daily.precipitation_sum[0],
        dateISO: fc.daily.time[0]
      });

      // --- Forecast ---
      const fcDom = document.getElementById('forecast-block');
      fcDom.innerHTML = "";
      for (let i = 1; i < fc.daily.time.length && i <= 5; ++i) {
        const iconCode = fc.daily.weathercode[i];
        let gust = fc.daily.windgusts_10m ? fc.daily.windgusts_10m[i] : null;
        fcDom.innerHTML += `
          <div class="forecast-card" tabindex="0" onclick="openPopup({
              title: '${dayOfWeek(fc.daily.time[i])}',
              summary: '',
              lowhigh: 'High: ${Math.round(fc.daily.temperature_2m_max[i])}°C<br>Low: ${Math.round(fc.daily.temperature_2m_min[i])}°C',
              extra: 'Gusts: ${gust !== null && gust !== undefined ? Math.round(gust) : '--'} km/h<br>Precip: ${fc.daily.precipitation_sum[i].toFixed(1)} mm',
              ai: \`${agoraAiAdvice({
                temp: fc.daily.temperature_2m_max[i],
                humidity: null, // daily doesn't have humidity
                gust: gust,
                precip: fc.daily.precipitation_sum[i],
                dateISO: fc.daily.time[i]
              }, i)}\`
            })">
            <div class="day">${dayOfWeek(fc.daily.time[i])}</div>
            <img class="icon" src="${openMeteoIcon(iconCode, 1)}" alt="" width="215" height="215">
            <div class="desc">${capitalize("")}</div>
            <div class="lowhigh">High: ${Math.round(fc.daily.temperature_2m_max[i])}°C<br>Low: ${Math.round(fc.daily.temperature_2m_min[i])}°C</div>
            <div class="gust">Gusts: ${gust !== null && gust !== undefined ? Math.round(gust) : '--'} km/h</div>
            <div class="precip">Precip: ${fc.daily.precipitation_sum[i].toFixed(1)} mm</div>
            ${agoraAiAdvice({
              temp: fc.daily.temperature_2m_max[i],
              humidity: null,
              gust: gust,
              precip: fc.daily.precipitation_sum[i],
              dateISO: fc.daily.time[i]
            }, i)}
          </div>
        `;
      }
    });

    function openPopup(opts) {
      document.getElementById('popup-title').textContent = opts.title || "";
      document.getElementById('popup-summary').textContent = opts.summary || "";
      document.getElementById('popup-lowhigh').innerHTML = opts.lowhigh || "";
      document.getElementById('popup-extra').innerHTML = opts.extra || "";
      document.getElementById('popup-ai').innerHTML = opts.ai || "";
      document.getElementById('popup-hist').innerHTML = opts.hist || "";
      document.getElementById('popup-bg').style.display = 'flex';
    }
    function closePopup() {
      document.getElementById('popup-bg').style.display = 'none';
    }
    document.getElementById('popup-bg').onclick = (e) => { if (e.target === e.currentTarget) closePopup(); }
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closePopup(); });
  </script>
</body>
</html>