<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Agora Weather Widget</title>
  <meta name="viewport" content="width=2000">
  <style>
    html, body {
      background: #181e2a;
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      color: #fff;
      font-family: 'Segoe UI', Arial, sans-serif;
    }
    #main-container {
      width: 2000px;
      height: 320px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      background: #181e2a;
      box-shadow: 0 2px 24px #0008;
      border-radius: 18px;
      overflow: hidden;
    }
    #current-block {
      width: 410px;
      min-width: 350px;
      max-width: 460px;
      height: 100%;
      background: #222c40;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: flex-start;
      padding: 28px 28px 16px 32px;
      box-sizing: border-box;
      border-right: 3px solid #222c40;
      gap: 6px;
      cursor: pointer;
      position: relative;
    }
    #current-block .temp {
      font-size: 4.7rem;
      font-weight: 600;
      margin-bottom: 0.02em;
      color: #fff;
      line-height: 1;
      text-shadow: 0 1px 14px #222;
    }
    #current-block .weather-row {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 2.1rem;
      font-weight: 400;
      color: #fff;
      margin-bottom: 0.13em;
    }
    #current-block .weather-row img {
      width: 46px; height: 46px; margin-right: 3px;
    }
    #current-block .summary {
      font-size: 1.13rem;
      color: #c0d2ed;
      font-weight: 400;
      margin-bottom: 0.1em;
      margin-top: 0.1em;
      max-width: 96%;
      word-break: break-word;
    }
    #current-block .details {
      font-size: 1.02rem;
      color: #c0d2ed;
      margin-bottom: 0.1em;
      margin-top: 0.08em;
      line-height: 1.4;
      white-space: pre-line;
    }
    #ai-advice {
      background: #252c48;
      color: #fee680;
      border-radius: 8px;
      font-size: 1.11rem;
      margin-top: 0.19em;
      padding: 7px 10px 7px 12px;
      font-weight: 500;
      max-width: 99%;
      box-shadow: 0 1px 8px #0002;
      min-height: 28px;
      margin-bottom: 2px;
      display: block;
    }
    #ai-advice strong { color: #fff6b2; }
    #forecast-block {
      flex: 1;
      display: flex;
      align-items: center;
      height: 100%;
      padding: 0 16px;
      overflow-x: auto;
      background: #181e2a;
      gap: 14px;
    }
    .forecast-card {
      min-width: 140px;
      max-width: 160px;
      height: 210px;
      background: #232f47;
      border-radius: 16px;
      padding: 14px 9px 9px 14px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      box-shadow: 0 1px 5px #0004;
      color: #fff;
      margin: 0 4px;
      justify-content: flex-start;
      cursor: pointer;
      transition: box-shadow 0.13s;
      position: relative;
    }
    .forecast-card:hover {
      box-shadow: 0 6px 28px #0007;
      background: #27334f;
    }
    .forecast-card .day {
      font-weight: bold;
      font-size: 1.14rem;
      margin-bottom: 5px;
      color: #fff;
    }
    .forecast-card .icon {
      font-size: 2.05rem;
      margin-bottom: 3px;
      width: 38px;
      height: 38px;
      display: block;
    }
    .forecast-card .desc {
      font-size: 1.00rem;
      color: #c0d2ed;
      margin-bottom: 2px;
      min-height: 28px;
      line-height: 1.15;
      white-space: pre-line;
    }
    .forecast-card .lowhigh, .forecast-card .gust, .forecast-card .precip {
      width: 100%;
      display: block;
    }
    .forecast-card .lowhigh {
      font-size: 1.19rem;
      font-weight: 600;
      color: #fff;
      margin-bottom: 0.1em;
    }
    .forecast-card .gust {
      font-size: 1.02rem;
      color: #aad7ff;
      margin-bottom: 0.08em;
      font-weight: 400;
    }
    .forecast-card .precip {
      font-size: 1.01rem;
      color: #96e8ff;
      margin-bottom: 0.08em;
      font-weight: 400;
    }
    #popup-bg {
      position: fixed;
      z-index: 99999;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(20, 30, 50, 0.86);
      display: none;
      align-items: center;
      justify-content: center;
    }
    #popup-content {
      background: #232f47;
      border-radius: 18px;
      padding: 36px 54px;
      color: #fff;
      font-size: 1.6rem;
      font-weight: 500;
      max-width: 480px;
      width: 92vw;
      box-shadow: 0 12px 40px #000c;
      line-height: 1.36;
      position: relative;
      text-align: center;
    }
    #popup-close {
      position: absolute;
      top: 10px; right: 22px;
      font-size: 2.3rem;
      color: #aad7ff;
      cursor: pointer;
      background: none;
      border: none;
    }
    #popup-title {
      font-size: 1.15em;
      font-weight: bold;
      margin-bottom: 10px;
    }
    #popup-summary, #popup-lowhigh, #popup-extra {
      margin-bottom: 8px;
    }
    #popup-ai {
      margin-top: 10px;
      font-size: 1.13rem;
      color: #fee680;
    }
    #popup-hist {
      margin-top: 14px;
      color: #aad7ff;
      font-size: 1.03rem;
      line-height: 1.22;
    }
    @media (max-width: 1300px) {
      #main-container { width: 99vw !important; }
      #forecast-block { gap: 7px; }
      .forecast-card { min-width: 110px; max-width:120px;}
    }
  </style>
</head>
<body>
  <div id="main-container">
    <div id="current-block" tabindex="0">
      <div class="temp" id="temp">--°C</div>
      <div class="weather-row" id="weather-row">
        <img id="cur-icon" src="" style="display:none;">
        <span id="weather-text">Loading…</span>
      </div>
      <div class="summary" id="summary"></div>
      <div class="details" id="details"></div>
      <div id="ai-advice"></div>
    </div>
    <div id="forecast-block"></div>
  </div>
  <!-- Popup for forecast summary & historical/ai -->
  <div id="popup-bg">
    <div id="popup-content">
      <button id="popup-close" onclick="closePopup()">&times;</button>
      <div id="popup-title"></div>
      <div id="popup-summary"></div>
      <div id="popup-lowhigh"></div>
      <div id="popup-extra"></div>
      <div id="popup-ai"></div>
      <div id="popup-hist"></div>
    </div>
  </div>
  <script>
    // --- Start AI ADVICE SYSTEM ---
    function agoraAiAdvice(opts, day) {
      // Rich advice bank for NZ dairy/farm conditions.
      // Add/expand as much as you like! All advice will match context or come from general pool.
      const advicePool = [
        // --- Weather-specific (with context) ---
        { cond: d => d.temp >= 28 && d.month >= 12 && d.month <= 2, msg: "Heatwave expected. Shift milking to cooler hours, check water troughs every 2 hours." },
        { cond: d => d.temp >= 25 && d.precip < 1, msg: "Dry and hot—rotate paddocks early and monitor for dust inhalation in stock." },
        { cond: d => d.temp <= 3 && d.month >= 6 && d.month <= 8, msg: "Frost warning—ice on tracks, take extra care moving stock. Salt high-risk walkways if possible." },
        { cond: d => d.precip >= 20, msg: "Heavy rain risk—avoid spreading effluent, check runoff controls." },
        { cond: d => d.precip >= 8 && d.month >= 8 && d.month <= 11, msg: "Wet spring soils—use back fences, monitor for pugging damage." },
        { cond: d => d.precip === 0 && d.temp > 22 && d.humidity < 55, msg: "Drought risk—check tank levels, and consider supplementary feed planning." },
        { cond: d => d.gust >= 55, msg: "High wind—secure gates and remove loose objects from around sheds. Take care near trees." },
        { cond: d => d.temp > 16 && d.humidity > 70 && d.month >= 1 && d.month <= 3, msg: "Facial eczema risk—begin zinc dosing and monitor spore counts." },
        { cond: d => d.temp > 18 && d.precip > 10 && d.month >= 10 && d.month <= 4, msg: "Lush grass and rain—risk of bloat. Check paddocks and provide hay." },
        { cond: d => d.temp < 7 && d.precip > 5 && d.month >= 3 && d.month <= 5, msg: "Cold, wet autumn—extra bedding for calves, and move animals off low-lying areas." },
        { cond: d => d.gust > 70, msg: "Severe wind warning—defer tall machinery use and inspect fences for fallen trees post-storm." },
        { cond: d => d.precip > 30, msg: "Flood alert—move animals and machinery to higher ground." },
        { cond: d => d.precip > 8 && d.month >= 6 && d.month <= 8, msg: "Winter rain—rotate break fences more frequently, check drains for blockages." },
        { cond: d => d.temp > 31, msg: "Extreme heat—delay heavy tasks to late afternoon and check all animals for heat stress symptoms." },
        { cond: d => d.humidity > 90, msg: "High humidity—monitor for mastitis and ensure ventilation in sheds." },

        // --- Compliance & Health/Safety ---
        { cond: d => d.temp < 10 && d.month >= 6 && d.month <= 8, msg: "Wear PPE gloves when handling chemicals—cold increases splash risk." },
        { cond: d => d.precip > 10, msg: "Muddy conditions—clear access to emergency exits and first aid supplies." },
        { cond: d => d.temp < 4, msg: "Keep chemical stores above 4°C to prevent damage to sensitive products." },
        { cond: d => d.gust > 60, msg: "Windy day—avoid burning rubbish and take care with light implements." },
        { cond: d => d.temp < 5, msg: "Check washdown area for ice—slip hazard." },
        { cond: d => d.month == 1 && d.precip > 5, msg: "Early summer wet—biosecurity check on stock for imported weed seeds." },
        { cond: d => d.temp > 27, msg: "High temps—record and log all animal treatments, as medicine withdrawal times may change in heat." },
        { cond: d => d.month == 7, msg: "Mid-winter: review hazard register and update all emergency contact info." },
        { cond: d => d.temp > 20 && d.month >= 2 && d.month <= 3, msg: "Annual audit time—prepare wash records and review effluent discharge logs." },

        // --- Animal health/seasonal ---
        { cond: d => d.temp < 10 && d.month >= 6 && d.month <= 8, msg: "Young calves need deep bedding and wind protection overnight." },
        { cond: d => d.temp > 21 && d.month >= 9 && d.month <= 11, msg: "Monitor for flystrike on young stock." },
        { cond: d => d.temp > 15 && d.precip > 8, msg: "Liver fluke risk after rain—check sheep and beef for signs." },
        { cond: d => d.temp < 6, msg: "Low temperature—provide extra feed for late-lactation cows to maintain condition." },
        { cond: d => d.temp > 25, msg: "High heat—sunscreen spray on pink noses and unpigmented teats." },
        { cond: d => d.precip > 5 && d.temp > 8, msg: "Worm challenge likely in young calves after rain—consider preventative drenching." },
        { cond: d => d.temp < 8 && d.month == 8, msg: "Spring: Check for sleepy sickness in ewes." },
        { cond: d => d.temp > 10 && d.month == 10, msg: "October: Monitor cows for ketosis and provide balanced minerals." },
        { cond: d => d.temp < 5 && d.month == 6, msg: "June: Check heaters and backup power for calf sheds." },

        // --- Paddock/farm tasks & reminders ---
        { cond: d => d.precip === 0 && d.temp > 18, msg: "No rain—schedule fencing repairs or water trough maintenance." },
        { cond: d => d.month == 11, msg: "Pre-summer—service irrigation and update water use consents." },
        { cond: d => d.temp > 20 && d.month >= 10 && d.month <= 12, msg: "Peak grass growth—move break fences daily for best utilization." },
        { cond: d => d.temp < 15 && d.month == 5, msg: "May: Book winter feed deliveries and check all bale covers for holes." },
        { cond: d => d.month == 4 && d.temp < 10, msg: "April: Wash and store all irrigation gear before first frost." },

        // --- Safety & legal compliance reminders ---
        { cond: d => d.gust > 30, msg: "Windy—secure ladders, check that all spray signage is visible at main gate." },
        { cond: d => d.precip > 8, msg: "Rain—remind staff of slips, trips, and falls, and update toolbox talk this week." },
        { cond: d => d.temp > 15 && d.temp < 22 && d.humidity > 70, msg: "Good conditions for weed spraying—check wind direction before application." },
        { cond: d => d.month == 7, msg: "July: Prepare for annual Worksafe inspection; check fire extinguishers and first aid kits." },

        // --- General (random draw, always present) ---
        { cond: d => true, msg: "Test your emergency generator this week to ensure it's ready for an outage." },
        { cond: d => true, msg: "Inspect all PPE for wear and replace damaged items before your next chemical delivery." },
        { cond: d => true, msg: "Review and log this month's water meter readings for your records." },
        { cond: d => true, msg: "Check your effluent system timer—update for daylight savings if needed." },
        { cond: d => true, msg: "Remind staff to close all chemical containers tightly after use." },
        { cond: d => true, msg: "Run a quick health & safety toolbox talk before morning milking this week." },
        { cond: d => true, msg: "Walk the boundary fences and record any needed repairs before the next storm." },
        { cond: d => true, msg: "Review vet treatments with your team; update whiteboard if changed." },
        { cond: d => true, msg: "Keep feed pads clean and check for early signs of acidosis in herd." },
        { cond: d => true, msg: "Review MSDS sheets for all farm chemicals—store updated copies in the dairy." },
        { cond: d => true, msg: "Test backup alarms on milk plant and effluent systems today." },
        // ...you can keep adding more for even more variety...
      ];

      // Extract info
      const m = new Date(opts.dateISO || Date.now()).getMonth() + 1;
      // Match all relevant advice for current conditions
      let matches = advicePool.filter(a => a.cond({
        month: m,
        temp: opts.temp,
        humidity: opts.humidity,
        precip: opts.precip,
        gust: opts.gust || 0
      }));

      // Pick 2-3 random relevant advices per load
      let shown = [];
      while (matches.length && shown.length < 3) {
        let idx = Math.floor(Math.random() * matches.length);
        shown.push(matches.splice(idx, 1)[0].msg);
      }
      return "Agora Ai: " + shown.join(' ');
    }
    // --- END AI ADVICE SYSTEM ---

    // Helper functions
    function iconUrl(icon) {
      if (!icon) return '';
      return `https://cdn.aerisapi.com/wxblox/icons/${icon}`;
    }
    function dayOfWeek(dateISO) {
      return new Date(dateISO).toLocaleDateString('en-NZ', { weekday: 'short' });
    }
    function capitalize(txt) {
      return (txt||'').charAt(0).toUpperCase() + (txt||'').slice(1);
    }

    // API for your station
    const currentUrl = 'https://data.api.xweather.com/conditions/pws_pukerimu?format=json&plimit=1&filter=1min&client_id=U8feQfLlcEfcXDfsWZs4C&client_secret=HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq';
    const forecastUrl = 'https://data.api.xweather.com/forecasts/pws_pukerimu?format=json&plimit=8&fields=periods.timestamp,periods.dateTimeISO,periods.tempC,periods.weather,periods.icon,periods.maxTempC,periods.minTempC,periods.humidity,periods.precipMM,periods.windSpeedKPH,periods.windGustKPH,periods.summary&client_id=U8feQfLlcEfcXDfsWZs4C&client_secret=HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq';

    // Fetch current, display, add onClick for historical popup
    fetch(currentUrl).then(r=>r.json()).then(json => {
      if (!json.success) throw new Error('No current conditions');
      const p = json.response[0].periods[0];
      document.getElementById('temp').textContent = typeof p.tempC === 'number' ? `${Math.round(p.tempC)}°C` : '--°C';
      const icon = p.icon || '';
      const icElem = document.getElementById('cur-icon');
      if (icon) {
        icElem.src = iconUrl(icon);
        icElem.style.display = '';
      } else {
        icElem.style.display = 'none';
      }
      document.getElementById('weather-text').textContent = capitalize(p.weather) || '--';
      document.getElementById('summary').textContent =
        capitalize(p.weatherPrimary || p.weather || '') +
        (p.sky !== undefined ? ` • Cloud Coverage: ${p.sky}%` : '');
      document.getElementById('details').innerHTML =
        `<b>Feels like:</b> ${p.feelslikeC !== null && p.feelslikeC !== undefined ? Math.round(p.feelslikeC)+'°C' : 'NA'}<br>
         <b>Humidity:</b> ${p.humidity !== null && p.humidity !== undefined ? p.humidity+'%' : 'NA'}<br>
         <b>Wind:</b> ${p.windSpeedKPH !== null && p.windSpeedKPH !== undefined ? Math.round(p.windSpeedKPH)+' km/h' : 'NA'}<br>
         <b>Gusts:</b> ${p.windGustKPH !== null && p.windGustKPH !== undefined ? Math.round(p.windGustKPH)+' km/h' : 'NA'}<br>
         <b>Pressure:</b> ${p.pressureMB !== null && p.pressureMB !== undefined ? p.pressureMB+' hPa' : 'NA'}<br>
         <b>Rain Today:</b> ${p.precipMM !== null && p.precipMM !== undefined ? p.precipMM+' mm' : '0 mm'}<br>
         <b>Rain Rate:</b> ${p.precipRateMM !== null && p.precipRateMM !== undefined ? p.precipRateMM+' mm/hr' : '0 mm/hr'}`;
      // Direct display of Agora Ai for current conditions (always visible)
      document.getElementById('ai-advice').textContent = agoraAiAdvice({
        temp: p.tempC,
        humidity: p.humidity,
        gust: p.windGustKPH,
        precip: p.precipMM,
        dateISO: p.dateTimeISO
      }, 0);
      // On click, show popup with AI + historical info (replace with real rain history)
      document.getElementById('current-block').onclick = () => openPopup({
        title: "Current Conditions",
        summary: capitalize(p.weatherPrimary || p.weather || ''),
        lowhigh: "",
        extra: `
          <b>Temp:</b> ${Math.round(p.tempC)}°C
          <b>Feels like:</b> ${p.feelslikeC!==null?Math.round(p.feelslikeC)+'°C':'NA'}<br>
          <b>Wind:</b> ${Math.round(p.windSpeedKPH||0)} km/h (${p.windDir||''})<br>
          <b>Humidity:</b> ${p.humidity||'NA'}%<br>
          <b>Rain Today:</b> ${p.precipMM||'0'} mm<br>
          <b>Rain Rate:</b> ${p.precipRateMM||'0'} mm/hr`,
        ai: agoraAiAdvice({
          temp: p.tempC,
          humidity: p.humidity,
          gust: p.windGustKPH,
          precip: p.precipMM,
          dateISO: p.dateTimeISO
        }, 0),
        hist: "<strong>Rain history:</strong><br>Today: 2 mm<br>This week: 17 mm<br>This month: 67 mm<br>This year: 895 mm"
      });
    });

    // Fetch forecast, skip today, show 6 boxes with Agora Ai popup
    fetch(forecastUrl).then(r=>r.json()).then(json => {
      if (!json.success) throw new Error('No forecast');
      const fc = json.response[0].periods || [];
      const fcDom = document.getElementById('forecast-block');
      fcDom.innerHTML = '';
      for (let i=1; i<fc.length; ++i) { // skip today, show next 6
        const p = fc[i];
        fcDom.innerHTML += `
          <div class="forecast-card" tabindex="0" onclick="openPopup({
            title: '${dayOfWeek(p.dateTimeISO)}',
            summary: \`${(p.summary||p.weather||'No summary').replace(/`/g,'')}\`,
            lowhigh: 'High: ${Math.round(p.maxTempC)}°C | Low: ${Math.round(p.minTempC)}°C',
            extra: 'Gusts: ${Math.round(p.windGustKPH||0)} km/h<br>Precip: ${p.precipMM||'0'} mm',
            ai: \`${agoraAiAdvice({
              temp: p.tempC||p.maxTempC,
              humidity: p.humidity,
              gust: p.windGustKPH,
              precip: p.precipMM,
              dateISO: p.dateTimeISO
            }, i)}\`
          })">
            <div class="day">${dayOfWeek(p.dateTimeISO)}</div>
            <img class="icon" src="${iconUrl(p.icon)}" alt="" width="40" height="40">
            <div class="desc">${capitalize(p.weather || '')}</div>
            <div class="lowhigh">High: ${Math.round(p.maxTempC)}°C<br>Low: ${Math.round(p.minTempC)}°C</div>
            <div class="gust">Gusts: ${Math.round(p.windGustKPH||0)} km/h</div>
            <div class="precip">Precip: ${p.precipMM||'0'} mm</div>
          </div>
        `;
      }
    });

    // Popup functions
    function openPopup(opts) {
      // opts: {title, summary, lowhigh, extra, ai, hist}
      document.getElementById('popup-title').textContent = opts.title || "";
      document.getElementById('popup-summary').textContent = opts.summary || "";
      document.getElementById('popup-lowhigh').textContent = opts.lowhigh || "";
      document.getElementById('popup-extra').innerHTML = opts.extra || "";
      document.getElementById('popup-ai').textContent = opts.ai || "";
      document.getElementById('popup-hist').innerHTML = opts.hist || "";
      document.getElementById('popup-bg').style.display = 'flex';
    }
    function closePopup() {
      document.getElementById('popup-bg').style.display = 'none';
    }

    // Dismiss popup on background click or Esc
    document.getElementById('popup-bg').onclick = function(e){
      if (e.target === this) closePopup();
    }
    document.addEventListener('keydown', function(e){
      if (e.key === 'Escape') closePopup();
    });
  </script>
</body>
</html>