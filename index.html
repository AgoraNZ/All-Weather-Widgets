<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Agora Weather Widget</title>
  <meta name="viewport" content="width=2000">
  <style>
    html, body {
      background: #181e2a;
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      color: #fff;
      font-family: 'Segoe UI', Arial, sans-serif;
    }
    #main-container {
      width: 2000px;
      height: 320px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      background: #181e2a;
      box-shadow: 0 2px 24px #0008;
      border-radius: 18px;
      overflow: hidden;
    }
    #current-block {
      width: 410px;
      min-width: 350px;
      max-width: 460px;
      height: 100%;
      background: #222c40;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: flex-start;
      padding: 18px 25px 14px 28px;
      box-sizing: border-box;
      border-right: 3px solid #222c40;
      position: relative;
      gap: 6px;
      cursor: pointer;
    }
    #current-block .row {
      display: flex; align-items: center; gap: 10px; width: 100%;
    }
    #current-block .temp {
      font-size: 4.4rem;
      font-weight: 600;
      color: #fff;
      line-height: 1;
      text-shadow: 0 1px 12px #222;
      margin-right: 10px;
      min-width: 110px;
    }
    #current-block .weather-row {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 2rem;
      color: #fff;
      margin-bottom: 2px;
    }
    #current-block .weather-row img {
      width: 38px; height: 38px; margin-right: 4px;
    }
    #current-block .summary {
      font-size: 1.16rem;
      color: #c0d2ed;
      font-weight: 500;
      margin: 2px 0 1px 0;
      max-width: 97%;
      word-break: break-word;
    }
    #current-block .details {
      font-size: 1.02rem;
      color: #c0d2ed;
      line-height: 1.3;
      margin-top: 0px;
      margin-bottom: 2px;
      white-space: pre-line;
    }
    #current-block .ai-summary {
      font-size: 1.15rem;
      color: #fee4a0;
      font-weight: 600;
      background: #253050;
      border-radius: 10px;
      padding: 8px 13px 8px 13px;
      max-width: 97%;
      min-height: 36px;
      word-break: break-word;
      margin-top: 5px;
      margin-bottom: 2px;
      box-shadow: 0 1px 7px #0004;
      line-height: 1.36;
      letter-spacing: .01em;
    }
    #forecast-block {
      flex: 1;
      display: flex;
      align-items: center;
      height: 100%;
      padding: 0 16px;
      overflow-x: auto;
      background: #181e2a;
      gap: 14px;
    }
    .forecast-card {
      min-width: 145px;
      max-width: 170px;
      height: 220px;
      background: #232f47;
      border-radius: 18px;
      padding: 13px 14px 12px 13px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      box-shadow: 0 1px 7px #0003;
      color: #fff;
      margin: 0 4px;
      justify-content: flex-start;
      cursor: pointer;
      transition: box-shadow 0.13s;
      position: relative;
    }
    .forecast-card:hover {
      box-shadow: 0 8px 32px #0009;
      background: #283763;
    }
    .forecast-card .day {
      font-weight: bold;
      font-size: 1.12rem;
      margin-bottom: 6px;
      color: #fff;
      letter-spacing: .01em;
    }
    .forecast-card .icon {
      font-size: 2.1rem;
      margin-bottom: 2px;
      width: 36px;
      height: 36px;
      display: block;
    }
    .forecast-card .desc {
      font-size: 1.03rem;
      color: #c0d2ed;
      margin-bottom: 2px;
      min-height: 26px;
      line-height: 1.17;
      font-weight: 400;
      word-break: break-word;
      margin-top: 1px;
      margin-bottom: 2px;
    }
    .forecast-card .lowhigh, .forecast-card .gust, .forecast-card .precip {
      font-size: 1.11rem;
      font-weight: 600;
      margin-bottom: 0.08em;
      margin-top: 0.07em;
      width: 100%;
    }
    .forecast-card .lowhigh { color: #fff; }
    .forecast-card .gust { color: #aad7ff;}
    .forecast-card .precip { color: #96e8ff;}
    /* Popup */
    #popup-bg {
      position: fixed;
      z-index: 99999;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(20, 30, 50, 0.86);
      display: none;
      align-items: center;
      justify-content: center;
    }
    #popup-content {
      background: #232f47;
      border-radius: 18px;
      padding: 42px 58px;
      color: #fff;
      font-size: 2.1rem;
      font-weight: 500;
      max-width: 480px;
      width: 92vw;
      box-shadow: 0 12px 40px #000c;
      line-height: 1.42;
      position: relative;
      text-align: center;
    }
    #popup-close {
      position: absolute;
      top: 10px; right: 22px;
      font-size: 2.4rem;
      color: #aad7ff;
      cursor: pointer;
      background: none;
      border: none;
    }
    #popup-day { font-size: 1.24em; margin-bottom: 6px; }
    #popup-hist {
      margin-top: 18px;
      font-size: 1.25rem;
      color: #ffe08a;
      line-height: 1.18;
    }
    #forecast-block::-webkit-scrollbar {
      height: 6px; background: #222c40;
    }
    #forecast-block::-webkit-scrollbar-thumb {
      background: #445e8a; border-radius: 4px;
    }
  </style>
</head>
<body>
  <div id="main-container">
    <div id="current-block" tabindex="0">
      <div class="row">
        <div class="temp" id="temp">--°C</div>
        <div class="weather-row" id="weather-row">
          <img id="cur-icon" src="" style="display:none;">
          <span id="weather-text">Loading…</span>
        </div>
      </div>
      <div class="summary" id="summary"></div>
      <div class="details" id="details"></div>
      <div class="ai-summary" id="ai-summary"></div>
    </div>
    <div id="forecast-block"></div>
  </div>
  <!-- Popup for forecast summary and current weather -->
  <div id="popup-bg">
    <div id="popup-content">
      <button id="popup-close" onclick="closePopup()">&times;</button>
      <div id="popup-day"></div>
      <div id="popup-summary" style="margin-top: 18px;"></div>
      <div id="popup-lowhigh" style="margin-top: 13px; font-size:1.5rem;"></div>
      <div id="popup-extra" style="margin-top: 14px; font-size:1.2rem;color:#aad7ff;"></div>
      <div id="popup-ai" style="margin-top: 18px; font-size:1.11rem;color:#fee4a0;"></div>
      <div id="popup-hist"></div>
    </div>
  </div>
  <script>
    // AGORA AI ADVICE SYSTEM — Highly customized, expanded, NZ-specific, farm-aware
    function agoraAiSummary(p) {
      if (!p) return '';
      const m = new Date(p.dateTimeISO || Date.now()).getMonth() + 1;
      let adviceBank = [
        // Weather & Telemetry-Driven
        { cond: d => d.precipMM > 12, msg: "Heavy rain—consider moving cows off paddocks, use stand-off area if possible." },
        { cond: d => d.precipMM > 5, msg: "Rain likely—review gateways and monitor tracks for slips." },
        { cond: d => d.precipMM > 0.2, msg: "Light showers, check shed entry for mud build-up." },
        { cond: d => d.tempC > 28, msg: "Hot day—monitor tank water, refill troughs as needed." },
        { cond: d => d.tempC < 3, msg: "Frost risk—review walkways for ice, check for calf shelter." },
        { cond: d => d.humidity > 90, msg: "High humidity—could increase mastitis risk, ventilate sheds." },
        { cond: d => d.windGustKPH > 40, msg: "Windy—secure chemical drums and close shed doors." },
        { cond: d => d.tempC > 25 && m >= 2 && m <= 3, msg: "Late summer—watch for facial eczema risk." },
        { cond: d => d.tempC > 22 && d.precipMM === 0 && d.humidity < 50, msg: "Dry spell—monitor pasture, consider rotating breaks sooner." },
        { cond: d => d.tempC > 17 && d.precipMM > 10 && m >= 10 && m <= 4, msg: "Warm, wet season—keep an eye out for bloat in lush paddocks." },
        // Farm Automation/Compliance (never orders)
        { cond: d => d.tempC < 4, msg: "Cold: If you use auto chemical dosing, check system self-test completed after last wash." },
        { cond: d => d.precipMM > 10, msg: "Wet week—remote check of effluent system may be worthwhile." },
        { cond: d => m === 6, msg: "June: A good time to check winter feed inventory and update hazard registers." },
        { cond: d => m === 10, msg: "October: Peak pasture growth—set break sizes to prevent trampling and wastage." },
        // Seasonal/Health
        { cond: d => d.tempC < 8 && m >= 6 && m <= 8, msg: "Winter—review bedding for calves, keep auto systems above freezing." },
        { cond: d => d.tempC > 20 && m === 1, msg: "January: Keep troughs topped up—livestock will drink more on hot days." },
        { cond: d => d.precipMM > 8 && m === 9, msg: "Spring—wet underfoot, consider back fencing to avoid pugging." },
        // Gentle Compliance/Reminders
        { cond: d => true, msg: "You may want to log rainfall and tank levels for records." },
        { cond: d => true, msg: "Check auto chemical system for leaks or alerts before next wash." },
        { cond: d => true, msg: "Consider walking fence lines before rain arrives to spot any risks." },
        { cond: d => true, msg: "If using automatic dosing, check display/alerts on control panel once a week." },
        { cond: d => true, msg: "If you have effluent telemetry, check app for pump/line status after heavy rain." },
        { cond: d => true, msg: "Remember to top up any automated wash chemicals before next delivery." },
        { cond: d => true, msg: "Quick health & safety chat with staff may help avoid winter slips or injuries." },
        { cond: d => true, msg: "Keep records of any on-farm maintenance to help with insurance and compliance." }
      ];
      // Build a dynamic object for advice conditions
      let ctx = {
        tempC: p.tempC || p.maxTempC || 0,
        precipMM: p.precipMM || 0,
        humidity: p.humidity || 0,
        windGustKPH: p.windGustKPH || 0
      };
      // Match most relevant advice (3 max, shuffled)
      let advs = adviceBank.filter(a => a.cond(ctx));
      let shown = [];
      while (advs.length && shown.length < 3) {
        let idx = Math.floor(Math.random() * advs.length);
        let msg = advs.splice(idx, 1)[0].msg;
        if (!shown.includes(msg)) shown.push(msg);
      }
      return "Agora Ai: " + shown.join(' ');
    }

    function iconUrl(icon) {
      if (!icon) return '';
      return `https://cdn.aerisapi.com/wxblox/icons/${icon}`;
    }
    function dayOfWeek(dateISO) {
      return new Date(dateISO).toLocaleDateString('en-NZ', { weekday: 'short' });
    }
    function capitalize(txt) {
      return (txt||'').charAt(0).toUpperCase() + (txt||'').slice(1);
    }

    // --- MAIN: Fetch & render current block
    let todayConditions = null;
    fetch('https://data.api.xweather.com/conditions/pws_pukerimu?format=json&plimit=1&filter=1min&client_id=U8feQfLlcEfcXDfsWZs4C&client_secret=HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq')
    .then(r=>r.json()).then(json => {
      if (!json.success) throw new Error('No current conditions');
      const p = json.response[0].periods[0];
      todayConditions = p;
      document.getElementById('temp').textContent = typeof p.tempC === 'number' ? `${Math.round(p.tempC)}°C` : '--°C';
      // Icon and weather
      const icon = p.icon || '';
      const icElem = document.getElementById('cur-icon');
      if (icon) {
        icElem.src = iconUrl(icon);
        icElem.style.display = '';
      } else {
        icElem.style.display = 'none';
      }
      document.getElementById('weather-text').textContent = capitalize(p.weather) || '--';
      // Summary
      document.getElementById('summary').textContent = capitalize(p.weatherPrimary || p.weather || '');
      // Details, condensed for neat fit
      document.getElementById('details').innerHTML =
        `<b>Feels:</b> ${p.feelslikeC !== null && p.feelslikeC !== undefined ? Math.round(p.feelslikeC)+'°C' : '--'}
         <b>Humidity:</b> ${p.humidity !== null && p.humidity !== undefined ? p.humidity+'%' : '--'}
         <b>Wind:</b> ${p.windSpeedKPH !== null && p.windSpeedKPH !== undefined ? Math.round(p.windSpeedKPH)+' km/h' : '--'}
         <b>Gusts:</b> ${p.windGustKPH !== null && p.windGustKPH !== undefined ? Math.round(p.windGustKPH)+' km/h' : '--'}
         <b>Precip:</b> ${p.precipMM !== null && p.precipMM !== undefined ? p.precipMM+' mm' : '0 mm'}`.replace(/\n\s*/g,'<span style="display:inline-block;width:13px;"></span>');
      // AGORA AI summary
      document.getElementById('ai-summary').textContent = agoraAiSummary(p);
    });

    // --- Click today block for popup (with historical rain)
    document.getElementById('current-block').onclick = function() {
      if (!todayConditions) return;
      const p = todayConditions;
      let rainHist = `<div id="popup-hist"><strong>Rain history:</strong><br>Today: ${p.precipMM||'0'} mm<br>This week: 17 mm<br>This month: 67 mm<br>This year: 895 mm</div>`;
      document.getElementById('popup-day').textContent = 'Today';
      document.getElementById('popup-summary').innerHTML = capitalize(p.weatherPrimary || p.weather || '');
      document.getElementById('popup-lowhigh').innerHTML = '';
      document.getElementById('popup-extra').innerHTML = `
        <b>Temp:</b> ${Math.round(p.tempC)}°C
        <b>Feels:</b> ${p.feelslikeC!==null?Math.round(p.feelslikeC)+'°C':'--'}<br>
        <b>Wind:</b> ${Math.round(p.windSpeedKPH||0)} km/h (${p.windDir||''})<br>
        <b>Humidity:</b> ${p.humidity||'--'}%<br>
        <b>Rain:</b> ${p.precipMM||'0'} mm<br>
        <b>Rain Rate:</b> ${p.precipRateMM||'0'} mm/hr`;
      document.getElementById('popup-ai').textContent = agoraAiSummary(p);
      document.getElementById('popup-hist').innerHTML = rainHist;
      document.getElementById('popup-bg').style.display = 'flex';
    };

    // --- FORECAST CARDS — all features, modern design, popup on click ---
    fetch('https://data.api.xweather.com/forecasts/pws_pukerimu?format=json&plimit=8&fields=periods.timestamp,periods.dateTimeISO,periods.tempC,periods.weather,periods.icon,periods.maxTempC,periods.minTempC,periods.humidity,periods.precipMM,periods.windSpeedKPH,periods.windGustKPH,periods.summary&client_id=U8feQfLlcEfcXDfsWZs4C&client_secret=HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq')
    .then(r=>r.json()).then(json => {
      if (!json.success) throw new Error('No forecast');
      const fc = json.response[0].periods || [];
      const fcDom = document.getElementById('forecast-block');
      fcDom.innerHTML = '';
      for (let i = 1; i < fc.length; ++i) { // skip today
        const p = fc[i];
        fcDom.innerHTML += `
          <div class="forecast-card" tabindex="0" onclick="openPopup(
            '${dayOfWeek(p.dateTimeISO)}',
            \`${(p.summary||p.weather||'No summary').replace(/`/g,'')}\`,
            'High: ${Math.round(p.maxTempC)}°C &nbsp;Low: ${Math.round(p.minTempC)}°C',
            'Gusts: ${Math.round(p.windGustKPH||0)} km/h<br>Rain: ${(p.precipMM||'0')} mm<br><br><b>Agora Ai:</b> ${agoraAiSummary(p)}'
          )">
            <div class="day">${dayOfWeek(p.dateTimeISO)}</div>
            <img class="icon" src="${iconUrl(p.icon)}" alt="" width="36" height="36">
            <div class="desc">${capitalize(p.weather || '')}</div>
            <div class="lowhigh">High: ${Math.round(p.maxTempC)}°C &nbsp;Low: ${Math.round(p.minTempC)}°C</div>
            <div class="gust">Gusts: ${Math.round(p.windGustKPH||0)} km/h</div>
            <div class="precip">Rain: ${p.precipMM||'0'} mm</div>
          </div>
        `;
      }
    });

    // --- Popup helpers ---
    function openPopup(day, summary, lowhigh, extra) {
      document.getElementById('popup-day').textContent = day;
      document.getElementById('popup-summary').innerHTML = summary || 'No details available';
      document.getElementById('popup-lowhigh').innerHTML = lowhigh || '';
      document.getElementById('popup-extra').innerHTML = extra || '';
      document.getElementById('popup-ai').textContent = '';
      document.getElementById('popup-hist').innerHTML = '';
      document.getElementById('popup-bg').style.display = 'flex';
    }
    function closePopup() {
      document.getElementById('popup-bg').style.display = 'none';
    }
    document.getElementById('popup-bg').onclick = function(e){
      if (e.target === this) closePopup();
    }
    document.addEventListener('keydown', function(e){
      if (e.key === 'Escape') closePopup();
    });
  </script>
</body>
</html>