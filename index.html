<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Agora Weather Widget</title>
  <meta name="viewport" content="width=2000">
  <style>
    html, body {
      background: #181e2a;
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      color: #fff;
      font-family: 'Segoe UI', Arial, sans-serif;
    }
    #main-container {
      width: 2000px;
      height: 320px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      background: #181e2a;
      box-shadow: 0 2px 24px #0008;
      border-radius: 18px;
      overflow: hidden;
    }
    #current-block {
      width: 410px;
      min-width: 350px;
      max-width: 460px;
      height: 100%;
      background: #222c40;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: flex-start;
      padding: 18px 25px 14px 28px;
      box-sizing: border-box;
      border-right: 3px solid #222c40;
      position: relative;
      gap: 6px;
    }
    #current-block .moon {
      margin-bottom: 2px;
      margin-top: 2px;
    }
    #forecast-block {
      flex: 1;
      display: flex;
      align-items: center;
      height: 100%;
      padding: 0 16px;
      overflow-x: auto;
      background: #181e2a;
      gap: 14px;
    }
    .forecast-card .moon {
      margin-bottom: 6px;
      margin-top: -1px;
    }
    /* Rest of your CSS is unchanged, keep from last code */
    /* ...snip for brevity, see prior messages for full CSS... */
  </style>
</head>
<body>
  <div id="main-container">
    <div id="current-block">
      <div class="moon"><canvas id="moon-today" width="34" height="34"></canvas></div>
      <div class="row">
        <div class="temp" id="temp">--°C</div>
        <div class="weather-row" id="weather-row">
          <img id="cur-icon" src="" style="display:none;">
          <span id="weather-text">Loading…</span>
        </div>
      </div>
      <div class="summary" id="summary"></div>
      <div class="details" id="details"></div>
      <div class="ai-summary" id="ai-summary"></div>
    </div>
    <div id="forecast-block"></div>
  </div>
  <div id="popup-bg" style="display:none;">
    <div id="popup-content">
      <button id="popup-close" onclick="closePopup()">&times;</button>
      <div id="popup-day"></div>
      <div id="popup-summary" style="margin-top: 18px;"></div>
      <div id="popup-lowhigh" style="margin-top: 13px; font-size:1.5rem;"></div>
      <div id="popup-extra" style="margin-top: 14px; font-size:1.2rem;color:#aad7ff;"></div>
    </div>
  </div>
  <script>
    // API endpoints (swap for your station)
    const currentUrl = 'https://data.api.xweather.com/conditions/pws_pukerimu?format=json&plimit=1&filter=1min&client_id=U8feQfLlcEfcXDfsWZs4C&client_secret=HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq';
    const forecastUrl = 'https://data.api.xweather.com/forecasts/pws_pukerimu?format=json&plimit=7&fields=periods.timestamp,periods.dateTimeISO,periods.tempC,periods.weather,periods.icon,periods.maxTempC,periods.minTempC,periods.humidity,periods.precipMM,periods.windSpeedKPH,periods.windGustKPH,periods.summary,periods.moonPhasePct&client_id=U8feQfLlcEfcXDfsWZs4C&client_secret=HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq';

    // Visually accurate moon drawing
    function drawRealMoon(canvas, phase) {
      // phase: 0 (new moon), 0.25 (first quarter), 0.5 (full), 0.75 (last quarter), 1 (new moon)
      // https://stackoverflow.com/questions/34882448/draw-the-moon-phase-on-canvas
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0,0,canvas.width,canvas.height);
      let r = canvas.width/2 - 2;
      let cx = canvas.width/2, cy = canvas.height/2;
      // Shadow direction (waning vs waxing)
      let waxing = phase <= 0.5;
      // Full moon: fill white circle
      ctx.save();
      ctx.beginPath();
      ctx.arc(cx,cy,r,0,2*Math.PI);
      ctx.closePath();
      ctx.fillStyle = "#fff";
      ctx.fill();
      ctx.restore();
      // Draw the shadowed part
      ctx.save();
      ctx.beginPath();
      ctx.arc(cx,cy,r,0,2*Math.PI);
      ctx.closePath();
      ctx.globalCompositeOperation = "destination-out";
      let phi = waxing ? phase : 1-phase;
      let offset = 2*r*phi;
      if (waxing) {
        ctx.ellipse(cx-offset, cy, r, r, 0, 0, Math.PI*2);
      } else {
        ctx.ellipse(cx+offset, cy, r, r, 0, 0, Math.PI*2);
      }
      ctx.fillStyle = "#111";
      ctx.fill();
      ctx.restore();
      // Draw rim
      ctx.beginPath();
      ctx.arc(cx,cy,r,0,2*Math.PI);
      ctx.strokeStyle = "#fff8";
      ctx.lineWidth = 1.1;
      ctx.stroke();
    }

    function iconUrl(icon) {
      if (!icon) return '';
      return `https://cdn.aerisapi.com/wxblox/icons/${icon}`;
    }
    function dayOfWeek(dateISO) {
      return new Date(dateISO).toLocaleDateString('en-NZ', { weekday: 'short' });
    }
    function capitalize(txt) {
      return (txt||'').charAt(0).toUpperCase() + (txt||'').slice(1);
    }
    function openPopup(day, summary, lowhigh, extra) {
      document.getElementById('popup-day').textContent = day;
      document.getElementById('popup-summary').textContent = summary || 'No details available';
      document.getElementById('popup-lowhigh').textContent = lowhigh || '';
      document.getElementById('popup-extra').innerHTML = extra || '';
      document.getElementById('popup-bg').style.display = 'flex';
    }
    function closePopup() {
      document.getElementById('popup-bg').style.display = 'none';
    }
    function agoraAiSummary(p) {
      if (!p) return '';
      let s = [];
      if ((p.precipMM || 0) > 8) { s.push("Heavy rain: consider moving cows off paddocks, watch tracks."); }
      else if ((p.precipMM || 0) > 2) { s.push("Rain likely. Plan inside jobs."); }
      else if ((p.precipMM || 0) > 0.2) { s.push("Light showers, watch for slippery gateways."); }
      if ((p.tempC || p.maxTempC || 0) < 3) { s.push("Very cold: monitor calves, possible frost."); }
      else if ((p.tempC || p.maxTempC || 0) < 8) { s.push("Cold—good for calf checks."); }
      else if ((p.tempC || p.maxTempC || 0) > 27) { s.push("Hot—check water troughs, avoid heat stress."); }
      if ((p.windGustKPH||0) > 38) { s.push("Strong/gusty winds: secure covers."); }
      else if ((p.windGustKPH||0) > 20) { s.push("Windy, be mindful of loose items."); }
      if ((p.tempC||0) < 2 || (p.minTempC||0) < 2) { s.push("Possible frost overnight."); }
      if (s.length < 1 && p.weather) s.push(capitalize(p.weather) + '.');
      return "Agora Ai: " + s.join(' ');
    }

    // Load current conditions
    fetch(currentUrl).then(r=>r.json()).then(json => {
      if (!json.success) throw new Error('No current conditions');
      const p = json.response[0].periods[0];
      document.getElementById('temp').textContent = typeof p.tempC === 'number' ? `${Math.round(p.tempC)}°C` : '--°C';
      const icon = p.icon || '';
      const icElem = document.getElementById('cur-icon');
      if (icon) {
        icElem.src = iconUrl(icon);
        icElem.style.display = '';
      } else {
        icElem.style.display = 'none';
      }
      document.getElementById('weather-text').textContent = capitalize(p.weather) || '--';
      let moonPct = (typeof p.moonPhasePct === 'number') ? p.moonPhasePct : 0.25;
      drawRealMoon(document.getElementById('moon-today'), moonPct);
      document.getElementById('summary').textContent =
        capitalize(p.weatherPrimary || p.weather || '');
      document.getElementById('details').innerHTML =
        `<b>Feels:</b> ${p.feelslikeC !== null && p.feelslikeC !== undefined ? Math.round(p.feelslikeC)+'°C' : '--'}
         <b>Humidity:</b> ${p.humidity !== null && p.humidity !== undefined ? p.humidity+'%' : '--'}
         <b>Wind:</b> ${p.windSpeedKPH !== null && p.windSpeedKPH !== undefined ? Math.round(p.windSpeedKPH)+' km/h' : '--'}
         <b>Gusts:</b> ${p.windGustKPH !== null && p.windGustKPH !== undefined ? Math.round(p.windGustKPH)+' km/h' : '--'}
         <b>Precip:</b> ${p.precipMM !== null && p.precipMM !== undefined ? p.precipMM+' mm' : '0 mm'}`.replace(/\n\s*/g,'<span style="display:inline-block;width:13px;"></span>');
      document.getElementById('ai-summary').textContent = agoraAiSummary(p);
    });

    // Load forecast
    fetch(forecastUrl).then(r=>r.json()).then(json => {
      if (!json.success) throw new Error('No forecast');
      const fc = json.response[0].periods || [];
      const fcDom = document.getElementById('forecast-block');
      fcDom.innerHTML = '';
      for (let i=1; i<fc.length; ++i) { // skip today
        const p = fc[i];
        fcDom.innerHTML += `
          <div class="forecast-card" tabindex="0" onclick="openPopup(
            '${dayOfWeek(p.dateTimeISO)}',
            \`${(p.summary||p.weather||'No summary').replace(/`/g,'')}\`,
            'High: ${Math.round(p.maxTempC)}°C&nbsp;&nbsp;Low: ${Math.round(p.minTempC)}°C',
            'Gusts: ${Math.round(p.windGustKPH||0)} km/h<br>Rain: ${(p.precipMM||'0')} mm<br><br><b>Agora Ai:</b> ${agoraAiSummary(p)}'
          )">
            <div class="day">${dayOfWeek(p.dateTimeISO)}</div>
            <canvas class="moon" id="moon${i}" width="34" height="34"></canvas>
            <img class="icon" src="${iconUrl(p.icon)}" alt="" width="36" height="36">
            <div class="lowhigh">High: ${Math.round(p.maxTempC)}°C &nbsp;Low: ${Math.round(p.minTempC)}°C</div>
            <div class="gust">Gusts: ${Math.round(p.windGustKPH||0)} km/h</div>
            <div class="precip">Rain: ${p.precipMM||'0'} mm</div>
          </div>
        `;
      }
      // Draw moons for forecast cards
      for (let i=1; i<fc.length; ++i) {
        const p = fc[i];
        let moonPhase = (typeof p.moonPhasePct === 'number') ? p.moonPhasePct : 0.25;
        drawRealMoon(document.getElementById('moon'+i), moonPhase);
      }
    });

    document.getElementById('popup-bg').onclick = function(e){
      if (e.target === this) closePopup();
    }
    document.addEventListener('keydown', function(e){
      if (e.key === 'Escape') closePopup();
    });
  </script>
</body>
</html>