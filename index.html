<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Agora Weather Widget</title>
  <meta name="viewport" content="width=2000">
  <style>
    html, body {
      background: #181e2a;
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      color: #fff;
      font-family: 'Segoe UI', Arial, sans-serif;
    }
    #main-container {
      width: 2000px;
      height: 380px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      background: #181e2a;
      box-shadow: 0 2px 24px #0008;
      border-radius: 18px;
      overflow: hidden;
    }
    #current-block {
      width: 410px;
      min-width: 350px;
      max-width: 460px;
      height: 100%;
      background: #222c40;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: flex-start;
      padding: 28px 28px 16px 32px;
      box-sizing: border-box;
      border-right: 3px solid #222c40;
      gap: 6px;
      position: relative;
      cursor: pointer;
    }
    #current-block .temp {
      font-size: 4.7rem;
      font-weight: 600;
      margin-bottom: 0.02em;
      color: #fff;
      line-height: 1;
      text-shadow: 0 1px 14px #222;
    }
    #current-block .weather-row {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 2.1rem;
      font-weight: 400;
      color: #fff;
      margin-bottom: 0.13em;
    }
    #current-block .weather-row img {
      width: 46px; height: 46px; margin-right: 3px;
    }
    #current-block .details {
      font-size: 1.01rem;
      color: #c0d2ed;
      margin-bottom: 0.07em;
      margin-top: 0.05em;
      line-height: 1.4;
      white-space: pre-line;
    }
    #current-block .rain-row {
      font-size: 1.07rem;
      color: #62c9fa;
      margin-bottom: 0.11em;
      margin-top: 0.05em;
      font-weight: 600;
    }
    #todays-advice {
      background: #253e62;
      color: #ffd25a;
      border-radius: 9px;
      font-size: 1.13rem;
      margin-top: 10px;
      margin-bottom: 1px;
      padding: 12px 15px 12px 16px;
      font-weight: 600;
      max-width: 98%;
      box-shadow: 0 2px 11px #0002;
      line-height: 1.45;
      letter-spacing: 0.01em;
      display: block;
      min-height: 50px;
      overflow-wrap: break-word;
      word-break: break-word;
    }
    #forecast-block {
      flex: 1;
      display: flex;
      align-items: flex-start;
      height: 100%;
      padding: 0 16px;
      overflow-x: auto;
      background: #181e2a;
      gap: 14px;
    }
    .forecast-card {
      min-width: 140px;
      max-width: 160px;
      height: 210px;
      background: #232f47;
      border-radius: 16px;
      padding: 14px 9px 9px 14px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      box-shadow: 0 1px 5px #0004;
      color: #fff;
      margin: 0 4px;
      justify-content: flex-start;
      cursor: pointer;
      transition: box-shadow 0.13s;
      position: relative;
    }
    .forecast-card:hover {
      box-shadow: 0 6px 28px #0007;
      background: #27334f;
    }
    .forecast-card .day {
      font-weight: bold;
      font-size: 1.14rem;
      margin-bottom: 5px;
      color: #fff;
    }
    .forecast-card .icon {
      font-size: 2.05rem;
      margin-bottom: 3px;
      width: 38px;
      height: 38px;
      display: block;
    }
    .forecast-card .desc {
      font-size: 1.00rem;
      color: #c0d2ed;
      margin-bottom: 2px;
      min-height: 28px;
      line-height: 1.15;
      white-space: pre-line;
    }
    .forecast-card .lowhigh, .forecast-card .gust, .forecast-card .precip {
      width: 100%;
      display: block;
    }
    .forecast-card .lowhigh {
      font-size: 1.17rem;
      font-weight: 600;
      color: #fff;
      margin-bottom: 0.07em;
    }
    .forecast-card .gust {
      font-size: 1.02rem;
      color: #aad7ff;
      margin-bottom: 0.08em;
      font-weight: 400;
    }
    .forecast-card .precip {
      font-size: 1.01rem;
      color: #96e8ff;
      margin-bottom: 0.08em;
      font-weight: 400;
    }
    #popup-bg {
      position: fixed;
      z-index: 99999;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(20, 30, 50, 0.86);
      display: none;
      align-items: center;
      justify-content: center;
    }
    #popup-content {
      background: #232f47;
      border-radius: 18px;
      padding: 36px 54px;
      color: #fff;
      font-size: 1.6rem;
      font-weight: 500;
      max-width: 480px;
      width: 92vw;
      box-shadow: 0 12px 40px #000c;
      line-height: 1.36;
      position: relative;
      text-align: center;
    }
    #popup-close {
      position: absolute;
      top: 10px; right: 22px;
      font-size: 2.3rem;
      color: #aad7ff;
      cursor: pointer;
      background: none;
      border: none;
    }
    #popup-title {
      font-size: 1.15em;
      font-weight: bold;
      margin-bottom: 10px;
    }
    #popup-summary, #popup-lowhigh, #popup-extra {
      margin-bottom: 8px;
    }
    #popup-ai {
      margin-top: 10px;
      font-size: 1.13rem;
      color: #fee680;
    }
    #popup-hist {
      margin-top: 14px;
      color: #aad7ff;
      font-size: 1.03rem;
      line-height: 1.22;
    }
    @media (max-width: 1300px) {
      #main-container { width: 99vw !important; }
      #forecast-block { gap: 7px; }
      .forecast-card { min-width: 110px; max-width: 120px; }
    }
  </style>
</head>
<body>
  <div id="main-container">
    <div id="current-block" tabindex="0">
      <div class="temp" id="temp">--°C</div>
      <div class="weather-row" id="weather-row">
        <img id="cur-icon" src="" style="display:none;" alt="">
        <span id="weather-text">Loading…</span>
      </div>
      <div class="details" id="details"></div>
      <div class="rain-row" id="rain-row"></div>
      <div id="todays-advice">Loading today’s AI advice…</div>
    </div>
    <div id="forecast-block"></div>
  </div>

  <!-- Popup for forecast details & AI advice -->
  <div id="popup-bg">
    <div id="popup-content">
      <button id="popup-close" onclick="closePopup()">&times;</button>
      <div id="popup-title"></div>
      <div id="popup-summary"></div>
      <div id="popup-lowhigh"></div>
      <div id="popup-extra"></div>
      <div id="popup-ai"></div>
      <div id="popup-hist"></div>
    </div>
  </div>

  <script>
    // --- UNIQUE, NON-REPEATING AI ADVICE SYSTEM ---
    function agoraAiAdvice(opts) {
      // Weather/seasonal advice takes priority, then fall back to practical daily jobs
      // Each entry provides context (why) and benefit
      const adviceWeather = [
        // Weather-triggered tips (dairy farm context)
        { cond: d => d.precip >= 20, msg: "Heavy rain is expected today. Shift stock off low paddocks and clear drains before milking to prevent pasture damage and flooding." },
        { cond: d => d.precip > 10, msg: "Persistent rain is forecast. Lay woodchips at gateways and stand-off areas to reduce mud." },
        { cond: d => d.precip > 4, msg: "Showers expected. Hose mud off the dairy yard after milking to keep it clean and safe." },
        { cond: d => d.temp >= 28, msg: "High heat today. Delay yarding until late afternoon and ensure all water lines are flowing so cows stay cool and hydrated." },
        { cond: d => d.temp > 24 && d.humidity > 70, msg: "Warm and humid weather increases facial eczema risk. Give cows zinc to help protect them." },
        { cond: d => d.temp < 5, msg: "Cold snap forecast. Give calves extra bedding and keep sheds closed overnight so they stay warm." },
        { cond: d => d.temp > 20 && d.precip < 2 && d.month >= 1 && d.month <= 3, msg: "Hot and dry conditions. Rotate paddocks early to avoid overgrazing, and clean water troughs to maintain water quality." },
        { cond: d => d.gust > 60, msg: "Strong winds expected. Secure shed doors and check fence lines for damage to prevent accidents or escapes." },
        { cond: d => d.temp < 8 && d.month == 8, msg: "Wet, cold August weather can harm hooves. Use a footbath at the shed exit to help prevent lameness." },
        { cond: d => d.temp > 18 && d.precip > 6, msg: "Pasture is lush after rain. Give cows some hay along with grazing to reduce the risk of bloat." },
        { cond: d => d.temp < 10 && d.month == 7, msg: "Cold July weather. Put up windbreaks for calves and ensure their bedding is dry to keep them healthy." }
      ];
      const adviceSeasonal = [
        // Seasonal calendar tips (monthly tasks)
        { cond: d => d.month == 8, msg: "August: Calving season is starting. Prepare a calving kit with iodine, clean towels, and colostrum feeders so you’re ready for newborn calves." },
        { cond: d => d.month == 9, msg: "September: Check springer paddock fences and add fresh bedding in shelters so expectant cows stay safe and comfortable." },
        { cond: d => d.month == 10, msg: "October: Plan ahead for mating. Ensure bulls are sound and have tail paint ready for heat detection." },
        { cond: d => d.month == 11, msg: "November: Do a quick mineral check on the herd. Prepare magnesium supplements to prevent grass staggers." },
        { cond: d => d.month == 12, msg: "December: Summer heat can cause algae. Check water troughs daily and clean out algae so stock have clean water." },
        { cond: d => d.month == 1, msg: "January: Hot weather ahead. Set up shade sails and check all tank ballcocks to ensure a steady water supply." },
        { cond: d => d.month == 2, msg: "February: Storm season. Fuel up the backup generator and test shed alarms in case of power outages." },
        { cond: d => d.month == 3, msg: "March: Autumn is coming. Secure silage covers and patch any holes to protect feed for winter." },
        { cond: d => d.month == 4, msg: "April: Winter feed planning. Book supplementary feed now and check bale covers for holes so feed stays dry." },
        { cond: d => d.month == 5, msg: "May: Winter is close. Service the effluent pump now to avoid breakdowns during the wet season." },
        { cond: d => d.month == 6, msg: "June: It’s mid-winter. Top up woodchips in stand-off areas and ensure all heaters are working to keep stock warm." },
        { cond: d => d.month == 7, msg: "July: Calving is near. Clean and disinfect calf trailers and pens to reduce disease risk for newborns." }
      ];
      const adviceEveryday = [
        // Daily/weekly routine tasks (randomized)
        "Check and refill paper towels in the staff wash-up area.",
        "Give a quick scrape and rinse to the pit floor after each milking.",
        "Clear grass and stones from the tanker track entry.",
        "Sweep the steps and entry to the plant room to reduce slips.",
        "Check the backup supply of gloves and boots in the shed.",
        "Run the vat agitator test to confirm the alarm sounds.",
        "Clean the filter at the shed water inlet.",
        "Inspect the chemical dosing system for any leaks.",
        "Disinfect calf feeders and hang them up to dry.",
        "Clear away any loose twine or rope from the yard.",
        "Spray weeds along fence lines on fine days.",
        "Check for empty chemical drums and move them to the recycling area.",
        "Tidy the storage bench and hang up all milking clusters.",
        "Sweep out the feed room and remove empty meal bags.",
        "Hose down the exit race for a cleaner walk-off."
      ];
      // Determine current conditions for advice logic
      const d = {
        month: (opts.dateISO ? new Date(opts.dateISO).getMonth() : new Date().getMonth()) + 1,
        temp: opts.temp,
        humidity: opts.humidity,
        precip: opts.precip,
        gust: opts.gust || 0
      };
      // Pick advice: one weather (if applicable) and one seasonal, else fallback to everyday
      let selected = [];
      let picked = new Set();
      // Weather-based advice
      for (let adv of adviceWeather) {
        if (adv.cond(d)) {
          selected.push(adv.msg);
          picked.add(adv.msg);
          break;
        }
      }
      // Seasonal advice (if not already picked)
      for (let adv of adviceSeasonal) {
        if (adv.cond(d) && !picked.has(adv.msg)) {
          selected.push(adv.msg);
          picked.add(adv.msg);
          break;
        }
      }
      // If less than 2 advices selected, add one routine task
      if (selected.length < 2) {
        // Shuffle the everyday tips array to get a random unique tip
        let idxs = Array.from({length: adviceEveryday.length}, (_, i) => i);
        for (let i = idxs.length - 1; i > 0; i--) {
          let j = Math.floor(Math.random() * (i + 1));
          [idxs[i], idxs[j]] = [idxs[j], idxs[i]];
        }
        for (let i = 0; i < idxs.length && selected.length < 2; ++i) {
          let tip = adviceEveryday[idxs[i]];
          if (!picked.has(tip)) {
            selected.push(tip);
            picked.add(tip);
          }
        }
      }
      // Return HTML string with each advice in its own <div>
      return selected.map(txt => `<div>${txt}</div>`).join('');
    }

    function iconUrl(icon) {
      if (!icon) return '';
      return `https://cdn.aerisapi.com/wxblox/icons/${icon}`;
    }
    function dayOfWeek(dateISO) {
      return new Date(dateISO).toLocaleDateString('en-NZ', { weekday: 'short' });
    }
    function capitalize(txt) {
      return (txt || '').charAt(0).toUpperCase() + (txt || '').slice(1);
    }

    // --- RAIN HISTORY STORAGE ---
    let rainHistory = { today: 0, week: 0, month: 0, year: 0 };

    // Fetch current conditions and update current box
    fetch('https://data.api.xweather.com/conditions/pws_pukerimu?format=json&plimit=1&filter=1min&client_id=U8feQfLlcEfcXDfsWZs4C&client_secret=HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq')
      .then(r => r.json())
      .then(json => {
        if (!json.success) throw new Error('No current conditions');
        const p = json.response[0].periods[0];
        // Current temperature and conditions
        document.getElementById('temp').textContent = 
          (typeof p.tempC === 'number') ? `${Math.round(p.tempC)}°C` : '--°C';
        const icon = p.icon || '';
        const icElem = document.getElementById('cur-icon');
        if (icon) {
          icElem.src = iconUrl(icon);
          icElem.style.display = '';
        } else {
          icElem.style.display = 'none';
        }
        document.getElementById('weather-text').textContent = capitalize(p.weather) || '--';

        // Details: feels like, humidity, wind, etc.
        document.getElementById('details').innerHTML =
          `<b>Feels like:</b> ${p.feelslikeC !== null && p.feelslikeC !== undefined ? Math.round(p.feelslikeC) + '°C' : 'NA'}<br>
           <b>Humidity:</b> ${p.humidity !== null && p.humidity !== undefined ? p.humidity + '%' : 'NA'}<br>
           <b>Wind:</b> ${p.windSpeedKPH !== null && p.windSpeedKPH !== undefined ? Math.round(p.windSpeedKPH) + ' km/h' : 'NA'}<br>
           <b>Gusts:</b> ${p.windGustKPH !== null && p.windGustKPH !== undefined ? Math.round(p.windGustKPH) + ' km/h' : 'NA'}<br>
           <b>Pressure:</b> ${p.pressureMB !== null && p.pressureMB !== undefined ? p.pressureMB + ' hPa' : 'NA'}`;

        // Rainfall today (observed so far)
        const todayRain = (p.precipMM !== null && p.precipMM !== undefined) ? p.precipMM : 0;
        document.getElementById('rain-row').innerHTML = `<b>Rainfall:</b> ${todayRain} mm today`;
        rainHistory.today = Number(todayRain) || 0;  // store for later

        // Insert AI advice for today
        document.getElementById('todays-advice').innerHTML = agoraAiAdvice({
          temp: p.tempC,
          humidity: p.humidity,
          gust: p.windGustKPH,
          precip: p.precipMM,
          dateISO: p.dateTimeISO
        });

        // Clicking current block opens detailed popup
        document.getElementById('current-block').onclick = () => openPopup({
          title: "Current Conditions",
          summary: "",
          lowhigh: "",
          extra: `<b>Temp:</b> ${Math.round(p.tempC)}°C<br>
                  <b>Feels like:</b> ${p.feelslikeC !== null ? Math.round(p.feelslikeC) + '°C' : 'NA'}<br>
                  <b>Wind:</b> ${Math.round(p.windSpeedKPH || 0)} km/h (${p.windDir || ''})<br>
                  <b>Humidity:</b> ${p.humidity || 'NA'}%<br>
                  <b>Rainfall:</b> ${p.precipMM || 0} mm today`,
          ai: agoraAiAdvice({
            temp: p.tempC,
            humidity: p.humidity,
            gust: p.windGustKPH,
            precip: p.precipMM,
            dateISO: p.dateTimeISO
          }),
          hist: `<strong>Rain history:</strong><br>
                 Today: ${p.precipMM || 0} mm<br>
                 This week: ${rainHistory.week} mm<br>
                 This month: ${rainHistory.month} mm<br>
                 This year: ${rainHistory.year} mm`
        });
      });

    // Fetch forecast and build forecast cards + update today’s forecast info
    fetch('https://data.api.xweather.com/forecasts/pws_pukerimu?format=json&plimit=8&fields=periods.timestamp,periods.dateTimeISO,periods.tempC,periods.weather,periods.icon,periods.maxTempC,periods.minTempC,periods.humidity,periods.precipMM,periods.windSpeedKPH,periods.windGustKPH,periods.summary&client_id=U8feQfLlcEfcXDfsWZs4C&client_secret=HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq')
      .then(r => r.json())
      .then(json => {
        if (!json.success) throw new Error('No forecast');
        const fc = json.response[0].periods || [];
        const fcDom = document.getElementById('forecast-block');
        fcDom.innerHTML = "";

        // Calculate rain history totals from forecast data
        const now = new Date();
        const weekAgo = new Date(now); weekAgo.setDate(now.getDate() - 6);
        const monthAgo = new Date(now); monthAgo.setMonth(now.getMonth() - 1);
        const yearAgo = new Date(now); yearAgo.setFullYear(now.getFullYear() - 1);
        let weekRain = 0, monthRain = 0, yearRain = 0;
        for (let period of fc) {
          let d = new Date(period.dateTimeISO);
          if (d >= weekAgo) weekRain += Number(period.precipMM) || 0;
          if (d >= monthAgo) monthRain += Number(period.precipMM) || 0;
          if (d >= yearAgo) yearRain += Number(period.precipMM) || 0;
        }
        rainHistory.week = Math.round(weekRain);
        rainHistory.month = Math.round(monthRain);
        rainHistory.year = Math.round(yearRain);

        // Update current box with today's forecast high/low and expected rain
        if (fc.length > 0) {
          const todayFc = fc[0];
          // Add high/low info to current details
          const detailsElem = document.getElementById('details');
          detailsElem.innerHTML += `<br><b>Today:</b> High ${Math.round(todayFc.maxTempC)}°C, Low ${Math.round(todayFc.minTempC)}°C`;
          // Update rain row with expected precipitation
          const observed = rainHistory.today || 0;
          const expected = todayFc.precipMM || 0;
          document.getElementById('rain-row').innerHTML = 
            `<b>Rainfall:</b> ${observed} mm so far today; ${expected} mm expected`;
        }

        // Create forecast cards for the next 7 days (skip index 0 because that's today)
        for (let i = 1; i < fc.length && i <= 7; ++i) {
          const p = fc[i];
          fcDom.innerHTML += `
            <div class="forecast-card" tabindex="0" onclick="openPopup({
                title: '${dayOfWeek(p.dateTimeISO)}',
                summary: '',
                lowhigh: 'High: ${Math.round(p.maxTempC)}°C<br>Low: ${Math.round(p.minTempC)}°C',
                extra: 'Gusts: ${Math.round(p.windGustKPH || 0)} km/h<br>Precip: ${p.precipMM || 0} mm',
                ai: \`${agoraAiAdvice({
                  temp: p.tempC || p.maxTempC,
                  humidity: p.humidity,
                  gust: p.windGustKPH,
                  precip: p.precipMM,
                  dateISO: p.dateTimeISO
                })}\`
              })">
              <div class="day">${dayOfWeek(p.dateTimeISO)}</div>
              <img class="icon" src="${iconUrl(p.icon)}" alt="" width="40" height="40">
              <div class="desc">${capitalize(p.weather || '')}</div>
              <div class="lowhigh">High: ${Math.round(p.maxTempC)}°C<br>Low: ${Math.round(p.minTempC)}°C</div>
              <div class="gust">Gusts: ${Math.round(p.windGustKPH || 0)} km/h</div>
              <div class="precip">Precip: ${p.precipMM || 0} mm</div>
            </div>
          `;
        }
      });

    // Popup helper functions
    function openPopup(opts) {
      document.getElementById('popup-title').textContent = opts.title || "";
      document.getElementById('popup-summary').textContent = opts.summary || "";
      document.getElementById('popup-lowhigh').innerHTML = opts.lowhigh || "";
      document.getElementById('popup-extra').innerHTML = opts.extra || "";
      document.getElementById('popup-ai').innerHTML = opts.ai || "";
      document.getElementById('popup-hist').innerHTML = opts.hist || "";
      document.getElementById('popup-bg').style.display = 'flex';
    }
    function closePopup() {
      document.getElementById('popup-bg').style.display = 'none';
    }
    // Close popup on backdrop click or Escape key
    document.getElementById('popup-bg').onclick = (e) => { if (e.target === e.currentTarget) closePopup(); }
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closePopup(); });
  </script>
</body>
</html>