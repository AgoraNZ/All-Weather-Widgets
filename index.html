<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Agora Weather Widget</title>
  <meta name="viewport" content="width=2000">
  <style>
    html, body {
      background: #181e2a;
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      color: #fff;
      font-family: 'Segoe UI', Arial, sans-serif;
    }
    #main-container {
      width: 2000px;
      height: 320px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      background: #181e2a;
      box-shadow: 0 2px 24px #0008;
      border-radius: 18px;
      overflow: hidden;
    }
    #current-block {
      width: 410px;
      min-width: 350px;
      max-width: 460px;
      height: 100%;
      background: #222c40;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: flex-start;
      padding: 28px 28px 16px 32px;
      box-sizing: border-box;
      border-right: 3px solid #222c40;
      gap: 6px;
      cursor: pointer;
      position: relative;
    }
    #current-block .temp {
      font-size: 4.7rem;
      font-weight: 600;
      margin-bottom: 0.02em;
      color: #fff;
      line-height: 1;
      text-shadow: 0 1px 14px #222;
    }
    #current-block .weather-row {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 2.1rem;
      font-weight: 400;
      color: #fff;
      margin-bottom: 0.13em;
    }
    #current-block .weather-row img {
      width: 46px; height: 46px; margin-right: 3px;
    }
    #current-block .summary {
      font-size: 1.13rem;
      color: #c0d2ed;
      font-weight: 400;
      margin-bottom: 0.1em;
      margin-top: 0.1em;
      max-width: 96%;
      word-break: break-word;
    }
    #current-block .details {
      font-size: 1.02rem;
      color: #c0d2ed;
      margin-bottom: 0.1em;
      margin-top: 0.08em;
      line-height: 1.4;
      white-space: pre-line;
    }
    #ai-advice {
      background: #252c48;
      color: #fee680;
      border-radius: 8px;
      font-size: 1.11rem;
      margin-top: 0.19em;
      padding: 7px 10px 7px 12px;
      font-weight: 500;
      max-width: 99%;
      box-shadow: 0 1px 8px #0002;
      min-height: 28px;
      margin-bottom: 2px;
      display: block;
    }
    #ai-advice strong { color: #fff6b2; }
    #forecast-block {
      flex: 1;
      display: flex;
      align-items: center;
      height: 100%;
      padding: 0 16px;
      overflow-x: auto;
      background: #181e2a;
      gap: 14px;
    }
    .forecast-card {
      min-width: 140px;
      max-width: 160px;
      height: 210px;
      background: #232f47;
      border-radius: 16px;
      padding: 14px 9px 9px 14px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      box-shadow: 0 1px 5px #0004;
      color: #fff;
      margin: 0 4px;
      justify-content: flex-start;
      cursor: pointer;
      transition: box-shadow 0.13s;
      position: relative;
    }
    .forecast-card:hover {
      box-shadow: 0 6px 28px #0007;
      background: #27334f;
    }
    .forecast-card .day {
      font-weight: bold;
      font-size: 1.14rem;
      margin-bottom: 5px;
      color: #fff;
    }
    .forecast-card .icon {
      font-size: 2.05rem;
      margin-bottom: 3px;
      width: 38px;
      height: 38px;
      display: block;
    }
    .forecast-card .desc {
      font-size: 1.00rem;
      color: #c0d2ed;
      margin-bottom: 2px;
      min-height: 28px;
      line-height: 1.15;
      white-space: pre-line;
    }
    .forecast-card .lowhigh, .forecast-card .gust, .forecast-card .precip {
      width: 100%;
      display: block;
    }
    .forecast-card .lowhigh {
      font-size: 1.19rem;
      font-weight: 600;
      color: #fff;
      margin-bottom: 0.1em;
    }
    .forecast-card .gust {
      font-size: 1.02rem;
      color: #aad7ff;
      margin-bottom: 0.08em;
      font-weight: 400;
    }
    .forecast-card .precip {
      font-size: 1.01rem;
      color: #96e8ff;
      margin-bottom: 0.08em;
      font-weight: 400;
    }
    #popup-bg {
      position: fixed;
      z-index: 99999;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(20, 30, 50, 0.86);
      display: none;
      align-items: center;
      justify-content: center;
    }
    #popup-content {
      background: #232f47;
      border-radius: 18px;
      padding: 36px 54px;
      color: #fff;
      font-size: 1.6rem;
      font-weight: 500;
      max-width: 480px;
      width: 92vw;
      box-shadow: 0 12px 40px #000c;
      line-height: 1.36;
      position: relative;
      text-align: center;
    }
    #popup-close {
      position: absolute;
      top: 10px; right: 22px;
      font-size: 2.3rem;
      color: #aad7ff;
      cursor: pointer;
      background: none;
      border: none;
    }
    #popup-title {
      font-size: 1.15em;
      font-weight: bold;
      margin-bottom: 10px;
    }
    #popup-summary, #popup-lowhigh, #popup-extra {
      margin-bottom: 8px;
    }
    #popup-ai {
      margin-top: 10px;
      font-size: 1.13rem;
      color: #fee680;
    }
    #popup-hist {
      margin-top: 14px;
      color: #aad7ff;
      font-size: 1.03rem;
      line-height: 1.22;
    }
    @media (max-width: 1300px) {
      #main-container { width: 99vw !important; }
      #forecast-block { gap: 7px; }
      .forecast-card { min-width: 110px; max-width:120px;}
    }
  </style>
</head>
<body>
  <div id="main-container">
    <div id="current-block" tabindex="0">
      <div class="temp" id="temp">--°C</div>
      <div class="weather-row" id="weather-row">
        <img id="cur-icon" src="" style="display:none;" alt="">
        <span id="weather-text">Loading…</span>
      </div>
      <div class="summary" id="summary"></div>
      <div class="details" id="details"></div>
      <div id="ai-advice"></div>
    </div>
    <div id="forecast-block"></div>
  </div>
  <!-- Popup for forecast summary & historical/ai -->
  <div id="popup-bg">
    <div id="popup-content">
      <button id="popup-close" onclick="closePopup()">&times;</button>
      <div id="popup-title"></div>
      <div id="popup-summary"></div>
      <div id="popup-lowhigh"></div>
      <div id="popup-extra"></div>
      <div id="popup-ai"></div>
      <div id="popup-hist"></div>
    </div>
  </div>
  <script>
    // API for your station
    const stationId = 'pws_pukerimu';
    const clientId  = 'U8feQfLlcEfcXDfsWZs4C';
    const clientSecret = 'HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq';
    const currentUrl = `https://data.api.xweather.com/conditions/${stationId}?format=json&plimit=1&filter=1min&client_id=${clientId}&client_secret=${clientSecret}`;
    const forecastUrl = `https://data.api.xweather.com/forecasts/${stationId}?format=json&plimit=8&fields=periods.timestamp,periods.dateTimeISO,periods.tempC,periods.weather,periods.icon,periods.maxTempC,periods.minTempC,periods.humidity,periods.precipMM,periods.windSpeedKPH,periods.windGustKPH,periods.summary&client_id=${clientId}&client_secret=${clientSecret}`;

    function iconUrl(icon) {
      if (!icon) return '';
      return `https://cdn.aerisapi.com/wxblox/icons/${icon}`;
    }
    function dayOfWeek(dateISO) {
      return new Date(dateISO).toLocaleDateString('en-NZ', { weekday: 'short' });
    }
    function capitalize(txt) {
      return (txt || '').charAt(0).toUpperCase() + (txt || '').slice(1);
    }
    // Agora AI recommendations (with short reasons)
    function agoraAiAdvice(opts) {
      let adv = [];
      const m = new Date(opts.dateISO || Date.now()).getMonth() + 1;
      // Spring (Aug-Nov)
      if (m >= 8 && m <= 11) {
        if (opts.temp >= 19 && opts.humidity >= 70) adv.push("Monitor for ryegrass staggers—warm, humid spring triggers it. Provide shade and water.");
        if (opts.precip >= 7) adv.push("Heavy rain likely—wet soils risk pugging. Use back fencing or stand-off pads.");
        if (opts.temp <= 4) adv.push("Cold snap expected. Young stock can chill quickly; shelter recommended.");
        adv.push("Spring calving: Check pasture cover and ensure balanced feeding for new calves.");
      }
      // Summer (Dec-Feb)
      if (m >= 12 || m <= 2) {
        if (opts.temp >= 25) adv.push("Heat stress likely. Cows need shade and frequent water refills in hot weather.");
        if (opts.precip === 0) adv.push("Dry spell—grass slows, monitor water tanks and pasture. Rotate early.");
        if (opts.gust >= 40) adv.push("Strong winds forecast. Secure loose gear and gates before gusts.");
        adv.push("Facial eczema risk rises in hot, humid periods. Check spore counts.");
      }
      // Autumn (Mar-May)
      if (m >= 3 && m <= 5) {
        if (opts.precip >= 10) adv.push("Heavy rain expected—risk of paddock damage. Shift stock off wet areas.");
        if (opts.temp <= 6) adv.push("Cooler temps reduce grass growth—review late-lactation cow condition.");
        adv.push("Autumn prep: Plan feed and assess cows for drying-off.");
      }
      // Winter (Jun-Aug)
      if (m >= 6 && m <= 8) {
        if (opts.temp <= 2) adv.push("Possible frost—calves need shelter and ice-free troughs.");
        if (opts.precip >= 6) adv.push("Wet underfoot—rotate grazing to protect pasture from damage.");
        adv.push("Winter feeding: Extra supplements may be needed during cold snaps.");
      }
      // Extreme/Notable Weather
      if (opts.temp >= 31) adv.push("Extreme heat warning. Delay work and check animals for shade and water.");
      if (opts.precip >= 30) adv.push("Flood risk today—move gear and stock to higher ground before rain peaks.");
      if (opts.gust >= 70) adv.push("Severe wind forecast. Inspect trees and fencing for safety.");
      // General fallback
      if (adv.length === 0) {
        if (opts.precip > 0) adv.push("Rain on the way. Check muddy gateways and rotate paddocks.");
        else adv.push("Dry period: Inspect water troughs and test lines for leaks.");
        adv.push("Walk fences and troughs as routine.");
      }
      return "Agora AI: " + adv.join(" ");
    }

    // Fetch daily precipitation totals for a date range (inclusive) from the station
    async function fetchSummaryTotals(fromDate, toDate) {
      const url = `https://data.api.xweather.com/observations/summary/${stationId}?format=json&from=${fromDate}&to=${toDate}&fields=periods.summary.precip.totalMM&client_id=${clientId}&client_secret=${clientSecret}`;
      const response = await fetch(url);
      const data = await response.json();
      if (!data.success) throw new Error('No summary data');
      const periods = data.response[0]?.periods || [];
      // Return array of precipitation totals (mm) for each day in range
      return periods.map(pr => {
        const total = pr.summary && pr.summary.precip ? pr.summary.precip.totalMM : null;
        return total !== null && total !== undefined ? total : 0;
      });
    }

    function openPopup(opts) {
      document.getElementById('popup-title').textContent = opts.title || "";
      document.getElementById('popup-summary').textContent = opts.summary || "";
      document.getElementById('popup-lowhigh').textContent = opts.lowhigh || "";
      document.getElementById('popup-extra').innerHTML = opts.extra || "";
      document.getElementById('popup-ai').textContent = opts.ai || "";
      document.getElementById('popup-hist').innerHTML = opts.hist || "";
      document.getElementById('popup-bg').style.display = 'flex';
    }
    function closePopup() {
      document.getElementById('popup-bg').style.display = 'none';
    }

    // Fetch current conditions, update display, and prepare popup with historical data
    fetch(currentUrl).then(r => r.json()).then(json => {
      if (!json.success) throw new Error('No current conditions');
      const p = json.response[0].periods[0];
      // Update current conditions display
      document.getElementById('temp').textContent = (typeof p.tempC === 'number') ? `${Math.round(p.tempC)}°C` : '--°C';
      const icon = p.icon || '';
      const icElem = document.getElementById('cur-icon');
      if (icon) {
        icElem.src = iconUrl(icon);
        icElem.style.display = '';
      } else {
        icElem.style.display = 'none';
      }
      document.getElementById('weather-text').textContent = capitalize(p.weather) || '--';
      document.getElementById('summary').textContent =
        capitalize(p.weatherPrimary || p.weather || '') +
        (p.sky !== undefined ? ` • Cloud Coverage: ${p.sky}%` : '');
      // Show initial details (Rain Today as -- mm until updated)
      document.getElementById('details').innerHTML =
        `<b>Feels like:</b> ${p.feelslikeC !== null && p.feelslikeC !== undefined ? Math.round(p.feelslikeC) + '°C' : 'NA'}<br>
         <b>Humidity:</b> ${p.humidity !== null && p.humidity !== undefined ? p.humidity + '%' : 'NA'}<br>
         <b>Wind:</b> ${p.windSpeedKPH !== null && p.windSpeedKPH !== undefined ? Math.round(p.windSpeedKPH) + ' km/h' : 'NA'}<br>
         <b>Gusts:</b> ${p.windGustKPH !== null && p.windGustKPH !== undefined ? Math.round(p.windGustKPH) + ' km/h' : 'NA'}<br>
         <b>Pressure:</b> ${p.pressureMB !== null && p.pressureMB !== undefined ? p.pressureMB + ' hPa' : 'NA'}<br>
         <b>Rain Today:</b> -- mm<br>
         <b>Rain Rate:</b> ${p.precipRateMM !== null && p.precipRateMM !== undefined ? p.precipRateMM + ' mm/hr' : '0 mm/hr'}`;
      // Direct display of Agora AI advice for current conditions
      document.getElementById('ai-advice').textContent = agoraAiAdvice({
        temp: p.tempC,
        humidity: p.humidity,
        gust: p.windGustKPH,
        precip: p.precipMM,
        dateISO: p.dateTimeISO
      });
      // Prepare to fetch rain history (today, week, month, year) and then set popup open on click
      const tz = 'Pacific/Auckland';
      const now = new Date();
      const todayStr = now.toLocaleDateString('en-CA', { timeZone: tz });
      // Calculate start dates for history ranges
      const weekAgoDate = new Date(now);
      weekAgoDate.setDate(weekAgoDate.getDate() - 6);
      const weekStartStr = weekAgoDate.toLocaleDateString('en-CA', { timeZone: tz });
      const [year, month] = todayStr.split('-');
      const firstOfMonthStr = `${year}-${month}-01`;
      // Fetch precipitation history in parallel
      Promise.all([
        fetchSummaryTotals(todayStr, todayStr),          // today
        fetchSummaryTotals(weekStartStr, todayStr),      // this week (last 7 days)
        fetchSummaryTotals(firstOfMonthStr, todayStr)    // this month
      ].concat((async () => {
        // Fetch year-to-date in segments of up to 30 days (due to API limits)
        let yearTotal = 0;
        let fromDate = new Date(Number(year), 0, 1);
        while (fromDate <= now) {
          let toDate = new Date(fromDate);
          toDate.setDate(toDate.getDate() + 29);
          if (toDate > now) toDate = new Date(now);
          const fromStr = fromDate.toLocaleDateString('en-CA', { timeZone: tz });
          const toStr = toDate.toLocaleDateString('en-CA', { timeZone: tz });
          try {
            const totals = await fetchSummaryTotals(fromStr, toStr);
            for (let val of totals) {
              if (val !== null && val !== undefined) yearTotal += Number(val);
            }
          } catch (e) {
            console.error('Year-to-date fetch failed for segment', fromStr, '-', toStr, e);
          }
          if (toDate >= now) break;
          // move to next day after toDate
          toDate.setDate(toDate.getDate() + 1);
          fromDate = toDate;
        }
        return yearTotal;
      })())).then(([todayArr, weekArr, monthArr, yearTotal]) => {
        const todayTotal = todayArr.length ? Number(todayArr[0]) : 0;
        const weekTotal = weekArr.reduce((sum, v) => sum + Number(v || 0), 0);
        const monthTotal = monthArr.reduce((sum, v) => sum + Number(v || 0), 0);
        yearTotal = yearTotal !== null && yearTotal !== undefined ? Number(yearTotal) : 0;
        // Round values to whole mm
        const rToday = Math.round(todayTotal);
        const rWeek = Math.round(weekTotal);
        const rMonth = Math.round(monthTotal);
        const rYear = Math.round(yearTotal);
        // Update details with actual Rain Today value
        document.getElementById('details').innerHTML =
          `<b>Feels like:</b> ${p.feelslikeC !== null && p.feelslikeC !== undefined ? Math.round(p.feelslikeC) + '°C' : 'NA'}<br>
           <b>Humidity:</b> ${p.humidity !== null && p.humidity !== undefined ? p.humidity + '%' : 'NA'}<br>
           <b>Wind:</b> ${p.windSpeedKPH !== null && p.windSpeedKPH !== undefined ? Math.round(p.windSpeedKPH) + ' km/h' : 'NA'}<br>
           <b>Gusts:</b> ${p.windGustKPH !== null && p.windGustKPH !== undefined ? Math.round(p.windGustKPH) + ' km/h' : 'NA'}<br>
           <b>Pressure:</b> ${p.pressureMB !== null && p.pressureMB !== undefined ? p.pressureMB + ' hPa' : 'NA'}<br>
           <b>Rain Today:</b> ${rToday} mm<br>
           <b>Rain Rate:</b> ${p.precipRateMM !== null && p.precipRateMM !== undefined ? p.precipRateMM + ' mm/hr' : '0 mm/hr'}`;
        // Build popup content strings
        const extraStr =
          `<b>Temp:</b> ${Math.round(p.tempC)}°C
           <b>Feels like:</b> ${p.feelslikeC !== null && p.feelslikeC !== undefined ? Math.round(p.feelslikeC) + '°C' : 'NA'}<br>
           <b>Wind:</b> ${Math.round(p.windSpeedKPH || 0)} km/h (${p.windDir || ''})<br>
           <b>Humidity:</b> ${p.humidity !== null && p.humidity !== undefined ? p.humidity + '%' : 'NA'}<br>
           <b>Rain Today:</b> ${rToday} mm<br>
           <b>Rain Rate:</b> ${p.precipRateMM !== null && p.precipRateMM !== undefined ? p.precipRateMM + ' mm/hr' : '0 mm/hr'>`;
        const histStr =
          `<strong>Rain history:</strong><br>Today: ${rToday} mm<br>This week: ${rWeek} mm<br>This month: ${rMonth} mm<br>This year: ${rYear} mm`;
        // Set up click and key events for current-block popup
        const currentBlock = document.getElementById('current-block');
        currentBlock.onclick = () => openPopup({
          title: "Current Conditions",
          summary: capitalize(p.weatherPrimary || p.weather || ''),
          lowhigh: "",
          extra: extraStr,
          ai: agoraAiAdvice({
            temp: p.tempC,
            humidity: p.humidity,
            gust: p.windGustKPH,
            precip: p.precipMM,
            dateISO: p.dateTimeISO
          }),
          hist: histStr
        });
        currentBlock.addEventListener('keydown', e => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            currentBlock.click();
          }
        });
      }).catch(err => {
        console.error("Rain history fetch failed:", err);
        // In case of error, still enable popup with limited info
        const currentBlock = document.getElementById('current-block');
        currentBlock.onclick = () => openPopup({
          title: "Current Conditions",
          summary: capitalize(p.weatherPrimary || p.weather || ''),
          lowhigh: "",
          extra: `
            <b>Temp:</b> ${Math.round(p.tempC)}°C
            <b>Feels like:</b> ${p.feelslikeC !== null ? Math.round(p.feelslikeC) + '°C' : 'NA'}<br>
            <b>Wind:</b> ${Math.round(p.windSpeedKPH || 0)} km/h (${p.windDir || ''})<br>
            <b>Humidity:</b> ${p.humidity || 'NA'}%<br>
            <b>Rain Today:</b> ${p.precipMM !== null && p.precipMM !== undefined ? p.precipMM + ' mm' : '0 mm'}<br>
            <b>Rain Rate:</b> ${p.precipRateMM !== null && p.precipRateMM !== undefined ? p.precipRateMM + ' mm/hr' : '0 mm/hr'`,
          ai: agoraAiAdvice({
            temp: p.tempC,
            humidity: p.humidity,
            gust: p.windGustKPH,
            precip: p.precipMM,
            dateISO: p.dateTimeISO
          }),
          hist: "<strong>Rain history:</strong><br>Data not available."
        });
        currentBlock.addEventListener('keydown', e => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            currentBlock.click();
          }
        });
      });
    });

    // Fetch forecast, skip today, display forecast cards with Agora AI advice in popup
    fetch(forecastUrl).then(r => r.json()).then(json => {
      if (!json.success) throw new Error('No forecast');
      const fc = json.response[0].periods || [];
      const fcDom = document.getElementById('forecast-block');
      fcDom.innerHTML = '';
      for (let i = 1; i < fc.length; ++i) { // skip index 0 (today), show next periods
        const p = fc[i];
        fcDom.innerHTML += `
          <div class="forecast-card" tabindex="0" onclick="openPopup({
            title: '${dayOfWeek(p.dateTimeISO)}',
            summary: \`${(p.summary || p.weather || 'No summary').replace(/`/g, '')}\`,
            lowhigh: 'High: ${Math.round(p.maxTempC)}°C | Low: ${Math.round(p.minTempC)}°C',
            extra: 'Gusts: ${Math.round(p.windGustKPH || 0)} km/h<br>Precip: ${p.precipMM || '0'} mm',
            ai: \`${agoraAiAdvice({
              temp: p.tempC || p.maxTempC,
              humidity: p.humidity,
              gust: p.windGustKPH,
              precip: p.precipMM,
              dateISO: p.dateTimeISO
            })}\`
          })">
            <div class="day">${dayOfWeek(p.dateTimeISO)}</div>
            <img class="icon" src="${iconUrl(p.icon)}" alt="" width="40" height="40">
            <div class="desc">${capitalize(p.weather || '')}</div>
            <div class="lowhigh">High: ${Math.round(p.maxTempC)}°C<br>Low: ${Math.round(p.minTempC)}°C</div>
            <div class="gust">Gusts: ${Math.round(p.windGustKPH || 0)} km/h</div>
            <div class="precip">Precip: ${p.precipMM || '0'} mm</div>
          </div>
        `;
      }
      // Enable keyboard activation for forecast cards
      document.querySelectorAll('.forecast-card').forEach(card => {
        card.addEventListener('keydown', e => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            card.click();
          }
        });
      });
    });

    // Dismiss popup on background click or Esc key
    document.getElementById('popup-bg').onclick = function(e) {
      if (e.target === this) closePopup();
    };
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') closePopup();
    });
  </script>
</body>
</html>