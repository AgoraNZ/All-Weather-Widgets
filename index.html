<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Farm Weather Widget</title>
  <meta name="viewport" content="width=2000">
  <style>
    html, body {
      background: #181e2a;
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      color: #fff;
      font-family: 'Segoe UI', Arial, sans-serif;
    }
    #main-container {
      width: 2000px;
      height: 320px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      background: #181e2a;
      box-shadow: 0 2px 24px #0008;
      border-radius: 18px;
      overflow: hidden;
    }
    #current-block {
      width: 390px;
      min-width: 340px;
      max-width: 420px;
      height: 100%;
      background: #222c40;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: flex-start;
      padding: 22px 20px 22px 32px;
      box-sizing: border-box;
      border-right: 3px solid #222c40;
      position: relative;
      cursor: pointer;
    }
    #current-block .temp {
      font-size: 4.3rem;
      font-weight: 600;
      margin-bottom: 0.1em;
      color: #fff;
      line-height: 1;
      text-shadow: 0 1px 16px #222;
    }
    #current-block .weather-row {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 2rem;
      font-weight: 400;
      color: #fff;
      margin-bottom: 0.13em;
    }
    #current-block .weather-row img {
      width: 42px; height: 42px; margin-right: 4px;
    }
    #current-block .summary-ai {
      font-size: 1.09rem;
      color: #fee4a0;
      font-weight: 500;
      margin-bottom: 0.7em;
      margin-top: 0.2em;
      background: #253050;
      border-radius: 12px;
      padding: 7px 12px;
      max-width: 97%;
      word-break: break-word;
      min-height: 46px;
      box-shadow: 0 1px 7px #0004;
    }
    #current-block .details {
      font-size: 1.02rem;
      color: #c0d2ed;
      margin-bottom: 0.18em;
      margin-top: 0.05em;
      line-height: 1.58;
      white-space: pre-line;
    }
    #current-block .moon-phase {
      font-size: 1.3rem;
      color: #aad7ff;
      margin: 6px 0 0 0;
      background: #263050;
      border-radius: 9px;
      padding: 3px 13px;
      letter-spacing: 1px;
      font-weight: 600;
    }
    #forecast-block {
      flex: 1;
      display: flex;
      align-items: center;
      height: 100%;
      padding: 0 8px;
      overflow-x: auto;
      background: #181e2a;
      gap: 14px;
    }
    .forecast-card {
      min-width: 122px;
      max-width: 135px;
      height: 210px;
      background: #232f47;
      border-radius: 14px;
      padding: 14px 10px 8px 10px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      box-shadow: 0 1px 5px #0004;
      color: #fff;
      margin: 0 3px;
      justify-content: flex-start;
      cursor: pointer;
      transition: box-shadow 0.13s;
      position: relative;
    }
    .forecast-card:hover {
      box-shadow: 0 6px 28px #0007;
      background: #27334f;
    }
    .forecast-card .day {
      font-weight: bold;
      font-size: 1.10rem;
      margin-bottom: 4px;
      color: #fff;
    }
    .forecast-card .icon {
      font-size: 2rem;
      margin-bottom: 2px;
      width: 38px;
      height: 38px;
      display: block;
    }
    .forecast-card .desc {
      font-size: 1.01rem;
      color: #c0d2ed;
      margin-bottom: 2px;
      min-height: 20px;
      line-height: 1.1;
      white-space: pre-line;
    }
    .forecast-card .moon-phase {
      font-size: 1.07rem;
      color: #aad7ff;
      margin-bottom: 3px;
      margin-top: 2px;
      padding: 2px 8px;
      background: #293356;
      border-radius: 7px;
      font-weight: 600;
    }
    .forecast-card .line {
      width: 94%;
      border-top: 1px solid #304162;
      margin: 3px 0 2px 0;
    }
    .forecast-card .item {
      font-size: 1.13rem;
      color: #fff;
      margin-bottom: 1px;
      font-weight: 500;
      line-height: 1.12;
    }
    .forecast-card .item span {
      color: #7ac6ff;
      margin-left: 6px;
      font-weight: 400;
    }
    #popup-bg {
      position: fixed;
      z-index: 99999;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(20, 30, 50, 0.86);
      display: none;
      align-items: center;
      justify-content: center;
    }
    #popup-content {
      background: #232f47;
      border-radius: 18px;
      padding: 38px 41px;
      color: #fff;
      font-size: 2rem;
      font-weight: 500;
      max-width: 440px;
      width: 92vw;
      box-shadow: 0 12px 40px #000c;
      line-height: 1.37;
      position: relative;
      text-align: center;
    }
    #popup-close {
      position: absolute;
      top: 10px; right: 22px;
      font-size: 2.2rem;
      color: #aad7ff;
      cursor: pointer;
      background: none;
      border: none;
    }
    #forecast-block::-webkit-scrollbar {
      height: 6px; background: #222c40;
    }
    #forecast-block::-webkit-scrollbar-thumb {
      background: #445e8a; border-radius: 4px;
    }
    @media (max-width: 1500px) {
      #main-container { width: 99vw; }
      #forecast-block { gap: 7px; }
      .forecast-card { min-width: 90px; max-width: 98px; }
      #current-block { min-width: 220px; max-width: 275px; }
    }
  </style>
</head>
<body>
  <div id="main-container">
    <div id="current-block" onclick="showRainHistory()">
      <div class="temp" id="temp">--Â°C</div>
      <div class="weather-row" id="weather-row">
        <img id="cur-icon" src="" style="display:none;">
        <span id="weather-text">Loadingâ€¦</span>
      </div>
      <div class="moon-phase" id="cur-moon">ðŸŒ‘ New Moon</div>
      <div class="summary-ai" id="summary-ai">Â </div>
      <div class="details" id="details"></div>
    </div>
    <div id="forecast-block"></div>
  </div>
  <!-- Popup for forecast summary or rainfall history -->
  <div id="popup-bg">
    <div id="popup-content">
      <button id="popup-close" onclick="closePopup()">&times;</button>
      <div id="popup-title"></div>
      <div id="popup-main" style="margin-top: 18px;"></div>
      <div id="popup-extra" style="margin-top: 13px; font-size:1.09rem;color:#aad7ff;"></div>
    </div>
  </div>
  <script>
    // Replace these with your station IDs
    const currentUrl = 'https://data.api.xweather.com/conditions/pws_pukerimu?format=json&plimit=1&filter=1min&client_id=U8feQfLlcEfcXDfsWZs4C&client_secret=HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq';
    const forecastUrl = 'https://data.api.xweather.com/forecasts/pws_pukerimu?format=json&plimit=7&fields=periods.timestamp,periods.dateTimeISO,periods.tempC,periods.weather,periods.icon,periods.maxTempC,periods.minTempC,periods.humidity,periods.precipMM,periods.windSpeedKPH,periods.windGustKPH,periods.summary,periods.moonPhase&client_id=U8feQfLlcEfcXDfsWZs4C&client_secret=HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq';

    // --- Utility Functions ---
    function iconUrl(icon) {
      if (!icon) return '';
      return `https://cdn.aerisapi.com/wxblox/icons/${icon}`;
    }
    function dayOfWeek(dateISO) {
      return new Date(dateISO).toLocaleDateString('en-NZ', { weekday: 'short' });
    }
    function capitalize(txt) {
      return (txt||'').charAt(0).toUpperCase() + (txt||'').slice(1);
    }
    function moonPhaseEmoji(phase) {
      if (!phase) return "ðŸŒ‘";
      // Rough mapping, can swap for icons if wanted
      phase = phase.toLowerCase();
      if (phase.includes("full")) return "ðŸŒ•";
      if (phase.includes("waning crescent")) return "ðŸŒ˜";
      if (phase.includes("waning gibbous")) return "ðŸŒ–";
      if (phase.includes("last quarter")) return "ðŸŒ—";
      if (phase.includes("first quarter")) return "ðŸŒ“";
      if (phase.includes("waxing crescent")) return "ðŸŒ’";
      if (phase.includes("waxing gibbous")) return "ðŸŒ”";
      if (phase.includes("new")) return "ðŸŒ‘";
      return "ðŸŒ™";
    }
    function openPopup(title, main, extra) {
      document.getElementById('popup-title').textContent = title || '';
      document.getElementById('popup-main').innerHTML = main || '';
      document.getElementById('popup-extra').innerHTML = extra || '';
      document.getElementById('popup-bg').style.display = 'flex';
    }
    function closePopup() {
      document.getElementById('popup-bg').style.display = 'none';
    }
    // AI daily summary for farmers
    function farmSummary(p) {
      let s = '';
      if (!p) return 'Weather unavailable.';
      if ((p.precipMM || 0) > 1) {
        s += `Expect rain or showers. Check cow tracks for mud.`;
      } else if ((p.precipMM || 0) > 0.1) {
        s += `Chance of light showers, moderate wind.`;
      } else if ((p.sky||0) > 80 && (p.tempC||0) < 10) {
        s += `Cloudy and cool.`;
      } else {
        s += `Mainly fine, light breeze.`;
      }
      if ((p.windGustKPH||0) > 35) {
        s += ` Gusty winds likely. Secure gear.`;
      }
      if ((p.tempC||0) < 2) {
        s += ` Possible frost.`;
      }
      if ((p.tempC||0) > 27) {
        s += ` Hotâ€”ensure water troughs are checked.`;
      }
      if ((p.precipMM||0) > 0.1) {
        s += ` Avoid paddock work if soils are wet.`;
      }
      if (s.length < 10 && p.weather) s = capitalize(p.weather)+'.';
      return s.trim();
    }

    // Dummy rainfall history
    function showRainHistory() {
      openPopup('Rainfall History',
        '<b>This week:</b> 8 mm<br><b>This month:</b> 41 mm<br><b>This year:</b> 562 mm',
        '<span style="font-size:1.3rem;color:#fee4a0">*Historical values not live, add endpoint for real data</span>'
      );
    }

    // --- Load Data ---
    // Current conditions
    fetch(currentUrl).then(r=>r.json()).then(json => {
      if (!json.success) throw new Error('No current conditions');
      const p = json.response[0].periods[0];
      document.getElementById('temp').textContent = typeof p.tempC === 'number' ? `${Math.round(p.tempC)}Â°C` : '--Â°C';
      // Icon and weather
      const icon = p.icon || '';
      const icElem = document.getElementById('cur-icon');
      if (icon) {
        icElem.src = iconUrl(icon);
        icElem.style.display = '';
      } else {
        icElem.style.display = 'none';
      }
      document.getElementById('weather-text').textContent = capitalize(p.weather) || '--';
      // Moon phase today
      fetch(forecastUrl).then(r=>r.json()).then(fj=>{
        const m = fj.response[0].periods[0].moonPhase || "New Moon";
        document.getElementById('cur-moon').innerHTML = `${moonPhaseEmoji(m)} ${m}`;
      });
      // AI Summary
      document.getElementById('summary-ai').textContent = farmSummary(p);
      // Details, formatted for neat fit
      document.getElementById('details').innerHTML =
        `<b>Feels:</b> ${p.feelslikeC !== null && p.feelslikeC !== undefined ? Math.round(p.feelslikeC)+'Â°C' : 'NA'} &nbsp; `+
        `<b>Hum:</b> ${p.humidity !== null && p.humidity !== undefined ? p.humidity+'%' : 'NA'}<br>` +
        `<b>Wind:</b> ${p.windSpeedKPH !== null && p.windSpeedKPH !== undefined ? Math.round(p.windSpeedKPH)+' km/h' : 'NA'}`+
        `<b> Gusts:</b> ${p.windGustKPH !== null && p.windGustKPH !== undefined ? Math.round(p.windGustKPH)+' km/h' : 'NA'}<br>` +
        `<b>Pres:</b> ${p.pressureMB !== null && p.pressureMB !== undefined ? p.pressureMB+' hPa' : 'NA'}`+
        `<b> Precip:</b> ${p.precipMM !== null && p.precipMM !== undefined ? p.precipMM+' mm' : '0 mm'}`;
    });

    // Forecast
    fetch(forecastUrl).then(r=>r.json()).then(json => {
      if (!json.success) throw new Error('No forecast');
      const fc = json.response[0].periods || [];
      const fcDom = document.getElementById('forecast-block');
      fcDom.innerHTML = '';
      for (let i=1; i<fc.length; ++i) { // skip today
        const p = fc[i];
        fcDom.innerHTML += `
          <div class="forecast-card" tabindex="0" onclick="openPopup(
            '${dayOfWeek(p.dateTimeISO)}',
            \`${(p.summary||p.weather||'No summary').replace(/`/g,'')}\`,
            'High: ${Math.round(p.maxTempC)}Â°C<br>Low: ${Math.round(p.minTempC)}Â°C<br>Gusts: ${Math.round(p.windGustKPH||0)} km/h<br>Rain: ${p.precipMM||'0'} mm',
            ''
          )">
            <div class="day">${dayOfWeek(p.dateTimeISO)}</div>
            <img class="icon" src="${iconUrl(p.icon)}" alt="" width="38" height="38">
            <div class="moon-phase">${moonPhaseEmoji(p.moonPhase)} ${p.moonPhase||''}</div>
            <div class="desc">${capitalize(p.weather || '')}</div>
            <div class="line"></div>
            <div class="item">High <span>${Math.round(p.maxTempC)}Â°C</span></div>
            <div class="item">Low <span>${Math.round(p.minTempC)}Â°C</span></div>
            <div class="item">Gusts <span>${Math.round(p.windGustKPH||0)} km/h</span></div>
            <div class="item">