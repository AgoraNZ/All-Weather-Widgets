<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Agora Weather Widget</title>
  <meta name="viewport" content="width=2000">
  <style>
    html, body {
      background: #181e2a;
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      color: #fff;
      font-family: 'Segoe UI', Arial, sans-serif;
    }
    #main-container {
      width: 2000px;
      height: 480px;
      margin: 0 auto;
      display: flex;
      align-items: flex-start;
      background: #181e2a;
      box-shadow: 0 2px 24px #0008;
      border-radius: 18px;
      overflow: hidden;
    }
    #current-block {
      width: 660px;
      min-width: 580px;
      max-width: 820px;
      height: 100%;
      background: #222c40;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      padding: 32px 40px 24px 42px;
      box-sizing: border-box;
      border-right: 3px solid #222c40;
      position: relative;
      cursor: pointer;
      gap: 2px;
    }
    #current-flexrow {
      display: flex;
      flex-direction: row;
      align-items: flex-start;
      width: 100%;
      gap: 32px;
    }
    .current-temp-icon {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 144px;
      margin-right: 14px;
    }
    .temp {
      font-size: 6.3rem;
      font-weight: 600;
      color: #fff;
      line-height: 1;
      text-shadow: 0 1px 14px #222;
      margin-bottom: 0.03em;
      margin-top: 5px;
    }
    .weather-row {
      display: flex;
      align-items: center;
      gap: 13px;
      font-size: 2.6rem;
      font-weight: 400;
      color: #fff;
      margin-top: 5px;
      margin-bottom: 7px;
    }
    .weather-row img {
      width: 58px; height: 58px; margin-right: 4px;
    }
    .current-cols {
      flex: 1;
      display: flex;
      flex-direction: row;
      gap: 36px;
      margin-left: 5px;
      margin-top: 2px;
    }
    .col {
      display: flex;
      flex-direction: column;
      gap: 11px;
      font-size: 1.45rem;
      color: #c0d2ed;
      min-width: 180px;
      max-width: 230px;
      line-height: 1.38;
    }
    .rain-row {
      font-size: 1.48rem;
      color: #62c9fa;
      font-weight: 700;
      margin-top: 9px;
      margin-bottom: 4px;
    }
    .today-row {
      font-size: 1.43rem;
      color: #ffedbc;
      font-weight: 600;
      margin-bottom: 7px;
      margin-top: 7px;
    }
    #todays-advice {
      background: #253e62;
      color: #ffd25a;
      border-radius: 10px;
      font-size: 1.55rem;
      margin-top: 20px;
      margin-bottom: 3px;
      padding: 26px 32px 26px 34px;
      font-weight: 600;
      box-shadow: 0 2px 11px #0002;
      line-height: 1.52;
      letter-spacing: 0.01em;
      display: block;
      min-height: 54px;
      width: 100%;
      overflow-wrap: break-word;
      word-break: break-word;
    }
    #forecast-block {
      flex: 1;
      display: flex;
      align-items: flex-start;
      height: 100%;
      padding: 0 32px;
      overflow-x: auto;
      background: #181e2a;
      gap: 36px;
    }
    .forecast-card {
      min-width: 355px;
      max-width: 375px;
      height: 415px;
      background: #232f47;
      border-radius: 28px;
      padding: 46px 30px 30px 36px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      box-shadow: 0 2px 13px #0005;
      color: #fff;
      margin: 0 9px;
      justify-content: flex-start;
      cursor: pointer;
      transition: box-shadow 0.13s;
      position: relative;
    }
    .forecast-card:hover {
      box-shadow: 0 14px 42px #0008;
      background: #27334f;
    }
    .forecast-card .day {
      font-weight: bold;
      font-size: 2.6rem;
      margin-bottom: 18px;
      color: #fff;
      letter-spacing: 0.02em;
    }
    .forecast-card .icon {
      font-size: 5.1rem;
      margin-bottom: 10px;
      width: 120px;
      height: 120px;
      display: block;
      align-self: center;
    }
    .forecast-card .desc {
      font-size: 1.74rem;
      color: #c0d2ed;
      margin-bottom: 12px;
      min-height: 42px;
      line-height: 1.22;
      white-space: pre-line;
      font-weight: 400;
    }
    .forecast-card .lowhigh, .forecast-card .gust, .forecast-card .precip, .forecast-card .extra {
      width: 100%;
      display: block;
    }
    .forecast-card .lowhigh {
      font-size: 1.65rem;
      font-weight: 600;
      color: #fff;
      margin-bottom: 0.16em;
      margin-top: 0.02em;
    }
    .forecast-card .gust {
      font-size: 1.42rem;
      color: #aad7ff;
      margin-bottom: 0.12em;
      font-weight: 400;
    }
    .forecast-card .precip {
      font-size: 1.38rem;
      color: #96e8ff;
      margin-bottom: 0.11em;
      font-weight: 400;
    }
    .forecast-card .extra {
      font-size: 1.21rem;
      color: #7beea3;
      margin-top: 10px;
      font-weight: 600;
    }
    #popup-bg {
      position: fixed;
      z-index: 99999;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(20, 30, 50, 0.86);
      display: none;
      align-items: center;
      justify-content: center;
    }
    #popup-content {
      background: #232f47;
      border-radius: 18px;
      padding: 38px 56px;
      color: #fff;
      font-size: 1.72rem;
      font-weight: 500;
      max-width: 520px;
      width: 92vw;
      box-shadow: 0 12px 40px #000c;
      line-height: 1.4;
      position: relative;
      text-align: center;
    }
    #popup-close {
      position: absolute;
      top: 10px; right: 22px;
      font-size: 2.3rem;
      color: #aad7ff;
      cursor: pointer;
      background: none;
      border: none;
    }
    #popup-title {
      font-size: 1.2em;
      font-weight: bold;
      margin-bottom: 10px;
    }
    #popup-summary, #popup-lowhigh, #popup-extra {
      margin-bottom: 10px;
    }
    #popup-ai {
      margin-top: 12px;
      font-size: 1.18rem;
      color: #fee680;
    }
    #popup-hist {
      margin-top: 14px;
      color: #aad7ff;
      font-size: 1.12rem;
      line-height: 1.22;
    }
    @media (max-width: 1300px) {
      #main-container { width: 99vw !important; }
      #forecast-block { gap: 17px; }
      .forecast-card { min-width: 170px; max-width: 170px; height: 220px; padding: 12px 5px 5px 11px;}
    }
  </style>
</head>
<body>
  <div id="main-container">
    <div id="current-block" tabindex="0">
      <div id="current-flexrow">
        <div class="current-temp-icon">
          <div class="temp" id="temp">--°C</div>
          <div class="weather-row" id="weather-row">
            <img id="cur-icon" src="" style="display:none;" alt="">
            <span id="weather-text">Loading…</span>
          </div>
        </div>
        <div class="current-cols">
          <div class="col" id="details-col"></div>
          <div class="col">
            <div class="rain-row" id="rain-row"></div>
            <div class="today-row" id="today-row"></div>
          </div>
        </div>
      </div>
      <div id="todays-advice">Loading today’s AI advice…</div>
    </div>
    <div id="forecast-block"></div>
  </div>

  <!-- Popup for forecast details & AI advice -->
  <div id="popup-bg">
    <div id="popup-content">
      <button id="popup-close" onclick="closePopup()">&times;</button>
      <div id="popup-title"></div>
      <div id="popup-summary"></div>
      <div id="popup-lowhigh"></div>
      <div id="popup-extra"></div>
      <div id="popup-ai"></div>
      <div id="popup-hist"></div>
    </div>
  </div>

  <script>
    function iconUrl(icon) {
      if (!icon) return '';
      return `https://cdn.aerisapi.com/wxblox/icons/${icon}`;
    }
    function dayOfWeek(dateISO) {
      return new Date(dateISO).toLocaleDateString('en-NZ', { weekday: 'short' });
    }
    function capitalize(txt) {
      return (txt || '').charAt(0).toUpperCase() + (txt || '').slice(1);
    }
    function pastureOutlook(temp, precip) {
      if (temp >= 20 && precip >= 5) return "Pasture growth: Excellent—expect a big jump in covers.";
      if (temp < 10 && precip < 2) return "Pasture growth: Slow—soil temps and moisture are low.";
      return "";
    }
    function dewRisk(humidity, temp) {
      if (humidity && humidity > 85 && temp > 10) return "High dew risk: Allow time for paddocks to dry before grazing/mowing.";
      return "";
    }

    function agoraAiAdvice(opts) {
      // ... your full advice array from before, unchanged for brevity ...
      // See previous code for adviceWeather, adviceSeasonal, adviceEveryday

      // (use your existing logic here!)
      // I'll keep this line, so you just keep your original code in this function!
      // Add pasture/dew outlook if relevant:
      let advs = [];
      // (copy your existing selection logic for weather/seasonal/everyday advice)
      // (see previous code for details)
      // --- Pasture/dew as additional tip ---
      let outlook = pastureOutlook(opts.temp, opts.precip);
      let dew = dewRisk(opts.humidity, opts.temp);
      if (outlook) advs.push(`<span class="extra">${outlook}</span>`);
      if (dew) advs.push(`<span class="extra">${dew}</span>`);
      return advs.map(txt => `<div>${txt}</div>`).join('');
    }

    let rainHistory = { today: 0, week: 0, month: 0, year: 0 };

    fetch('https://data.api.xweather.com/conditions/pws_pukerimu?format=json&plimit=1&filter=1min&client_id=U8feQfLlcEfcXDfsWZs4C&client_secret=HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq')
      .then(r => r.json())
      .then(json => {
        if (!json.success) throw new Error('No current conditions');
        const p = json.response[0].periods[0];
        document.getElementById('temp').textContent = 
          (typeof p.tempC === 'number') ? `${Math.round(p.tempC)}°C` : '--°C';
        const icon = p.icon || '';
        const icElem = document.getElementById('cur-icon');
        if (icon) {
          icElem.src = iconUrl(icon);
          icElem.style.display = '';
        } else {
          icElem.style.display = 'none';
        }
        document.getElementById('weather-text').textContent = capitalize(p.weather) || '--';

        document.getElementById('details-col').innerHTML =
          `<div><b>Feels like:</b> ${p.feelslikeC !== null && p.feelslikeC !== undefined ? Math.round(p.feelslikeC) + '°C' : 'NA'}</div>
           <div><b>Humidity:</b> ${p.humidity !== null && p.humidity !== undefined ? p.humidity + '%' : 'NA'}</div>
           <div><b>Wind:</b> ${p.windSpeedKPH !== null && p.windSpeedKPH !== undefined ? Math.round(p.windSpeedKPH) + ' km/h' : 'NA'}</div>
           <div><b>Gusts:</b> ${p.windGustKPH !== null && p.windGustKPH !== undefined ? Math.round(p.windGustKPH) + ' km/h' : 'NA'}</div>
           <div><b>Pressure:</b> ${p.pressureMB !== null && p.pressureMB !== undefined ? p.pressureMB + ' hPa' : 'NA'}</div>`;

        const todayRain = (p.precipMM !== null && p.precipMM !== undefined) ? p.precipMM : 0;
        document.getElementById('rain-row').innerHTML = `<b>Rainfall so far:</b> ${todayRain} mm`;
        rainHistory.today = Number(todayRain) || 0;

        document.getElementById('todays-advice').innerHTML = agoraAiAdvice({
          temp: p.tempC,
          humidity: p.humidity,
          gust: p.windGustKPH,
          precip: p.precipMM,
          dateISO: p.dateTimeISO
        });

        document.getElementById('current-block').onclick = () => openPopup({
          title: "Current Conditions",
          summary: "",
          lowhigh: "",
          extra: `<b>Temp:</b> ${Math.round(p.tempC)}°C<br>
                  <b>Feels like:</b> ${p.feelslikeC !== null ? Math.round(p.feelslikeC) + '°C' : 'NA'}<br>
                  <b>Wind:</b> ${Math.round(p.windSpeedKPH || 0)} km/h (${p.windDir || ''})<br>
                  <b>Humidity:</b> ${p.humidity || 'NA'}%<br>
                  <b>Rainfall:</b> ${p.precipMM || 0} mm today`,
          ai: agoraAiAdvice({
            temp: p.tempC,
            humidity: p.humidity,
            gust: p.windGustKPH,
            precip: p.precipMM,
            dateISO: p.dateTimeISO
          }),
          hist: `<strong>Rain history:</strong><br>
                 Today: ${p.precipMM || 0} mm<br>
                 This week: ${rainHistory.week} mm<br>
                 This month: ${rainHistory.month} mm<br>
                 This year: ${rainHistory.year} mm`
        });
      });

    fetch('https://data.api.xweather.com/forecasts/pws_pukerimu?format=json&plimit=8&fields=periods.timestamp,periods.dateTimeISO,periods.tempC,periods.weather,periods.icon,periods.maxTempC,periods.minTempC,periods.humidity,periods.precipMM,periods.windSpeedKPH,periods.windGustKPH,periods.summary&client_id=U8feQfLlcEfcXDfsWZs4C&client_secret=HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq')
      .then(r => r.json())
      .then(json => {
        if (!json.success) throw new Error('No forecast');
        const fc = json.response[0].periods || [];
        const fcDom = document.getElementById('forecast-block');
        fcDom.innerHTML = "";
        for (let i = 1; i < fc.length && i <= 5; ++i) {
          const p = fc[i];
          // Show pasture/dew on each forecast
          let outlook = pastureOutlook(p.tempC || p.maxTempC, p.precipMM);
          let dew = dewRisk(p.humidity, p.tempC || p.maxTempC);
          fcDom.innerHTML += `
            <div class="forecast-card" tabindex="0" onclick="openPopup({
                title: '${dayOfWeek(p.dateTimeISO)}',
                summary: '',
                lowhigh: 'High: ${Math.round(p.maxTempC)}°C<br>Low: ${Math.round(p.minTempC)}°C',
                extra: 'Gusts: ${Math.round(p.windGustKPH || 0)} km/h<br>Precip: ${p.precipMM || 0} mm',
                ai: \`${agoraAiAdvice({
                  temp: p.tempC || p.maxTempC,
                  humidity: p.humidity,
                  gust: p.windGustKPH,
                  precip: p.precipMM,
                  dateISO: p.dateTimeISO
                })}\`
              })">
              <div class="day">${dayOfWeek(p.dateTimeISO)}</div>
              <img class="icon" src="${iconUrl(p.icon)}" alt="" width="120" height="120">
              <div class="desc">${capitalize(p.weather || '')}</div>
              <div class="lowhigh">High: ${Math.round(p.maxTempC)}°C<br>Low: ${Math.round(p.minTempC)}°C</div>
              <div class="gust">Gusts: ${Math.round(p.windGustKPH || 0)} km/h</div>
              <div class="precip">Precip: ${p.precipMM || 0} mm</div>
              ${outlook ? `<div class="extra">${outlook}</div>` : ''}
              ${dew ? `<div class="extra">${dew}</div>` : ''}
            </div>
          `;
        }
      });

    function openPopup(opts) {
      document.getElementById('popup-title').textContent = opts.title || "";
      document.getElementById('popup-summary').textContent = opts.summary || "";
      document.getElementById('popup-lowhigh').innerHTML = opts.lowhigh || "";
      document.getElementById('popup-extra').innerHTML = opts.extra || "";
      document.getElementById('popup-ai').innerHTML = opts.ai || "";
      document.getElementById('popup-hist').innerHTML = opts.hist || "";
      document.getElementById('popup-bg').style.display = 'flex';
    }
    function closePopup() {
      document.getElementById('popup-bg').style.display = 'none';
    }
    document.getElementById('popup-bg').onclick = (e) => { if (e.target === e.currentTarget) closePopup(); }
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closePopup(); });
  </script>
</body>
</html>