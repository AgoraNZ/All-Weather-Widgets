<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Agora Weather Widget</title>
  <meta name="viewport" content="width=2000">
  <style>
    html, body {
      background: #181e2a;
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      color: #fff;
      font-family: 'Segoe UI', Arial, sans-serif;
    }
    #main-container {
      width: 2000px;
      height: 480px;
      margin: 0 auto;
      display: flex;
      align-items: flex-start;
      background: #181e2a;
      box-shadow: 0 2px 24px #0008;
      border-radius: 18px;
      overflow: hidden;
    }
    #current-block {
      width: 620px;
      min-width: 480px;
      max-width: 660px;
      height: 100%;
      background: #222c40;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      padding: 24px 28px 20px 32px;
      box-sizing: border-box;
      border-right: 3px solid #222c40;
      position: relative;
      cursor: pointer;
      gap: 2px;
    }
    #current-flexrow {
      display: flex;
      flex-direction: row;
      align-items: flex-start;
      width: 100%;
      gap: 18px;
    }
    .current-temp-icon {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 110px;
      margin-right: 10px;
    }
    .temp {
      font-size: 4.5rem;
      font-weight: 600;
      color: #fff;
      line-height: 1;
      margin-bottom: 0.03em;
      margin-top: 5px;
    }
    .weather-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 2rem;
      color: #fff;
      margin-top: 3px;
      margin-bottom: 4px;
    }
    .weather-row img {
      width: 40px;
      height: 40px;
      margin-right: 2px;
    }
    .current-cols {
      flex: 1;
      display: flex;
      flex-direction: row;
      gap: 20px;
      margin-left: 2px;
      margin-top: 2px;
    }
    .col {
      display: flex;
      flex-direction: column;
      gap: 7px;
      font-size: 1.13rem;
      color: #c0d2ed;
      min-width: 120px;
      max-width: 160px;
      line-height: 1.3;
    }
    .rain-row {
      font-size: 1.09rem;
      color: #62c9fa;
      font-weight: 600;
      margin-top: 3px;
      margin-bottom: 1px;
    }
    .hail-row {
      font-size: 1.09rem;
      color: #ff6b6b;
      font-weight: 700;
      margin-top: 3px;
      margin-bottom: 1px;
    }
    .today-row {
      font-size: 1.10rem;
      color: #ffedbc;
      font-weight: 500;
      margin-bottom: 2px;
      margin-top: 2px;
    }
    #todays-advice {
      background: #253e62;
      color: #ffd25a;
      border-radius: 8px;
      font-size: 1.18rem;
      margin-top: 11px;
      margin-bottom: 1px;
      padding: 12px 13px 12px 16px;
      font-weight: 600;
      box-shadow: 0 2px 11px #0002;
      line-height: 1.4;
      display: block;
      min-height: 38px;
      width: 100%;
      overflow-wrap: break-word;
    }
    #forecast-block {
      flex: 1;
      display: flex;
      align-items: flex-start;
      height: 100%;
      background: #181e2a;
      gap: 12px;
      padding: 0 20px;
      justify-content: space-between;
    }
    .forecast-card {
      flex: 1 1 0;
      min-width: 0;
      max-width: 235px;
      height: 100%;
      background: #232f47;
      border-radius: 16px;
      padding: 15px 7px 10px 13px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      box-shadow: 0 1px 5px #0004;
      color: #fff;
      margin: 0;
      justify-content: flex-start;
      cursor: pointer;
      transition: box-shadow 0.13s;
      position: relative;
    }
    .forecast-card:hover {
      box-shadow: 0 6px 22px #0008;
      background: #27334f;
    }
    .forecast-card .day {
      font-weight: bold;
      font-size: 1.13rem;
      margin-bottom: 4px;
      color: #fff;
      letter-spacing: 0.01em;
    }
    .forecast-card .icon {
      width: 34px;
      height: 34px;
      margin-bottom: 4px;
      align-self: center;
    }
    .forecast-card .desc {
      font-size: 1.01rem;
      color: #c0d2ed;
      margin-bottom: 2px;
      min-height: 18px;
      line-height: 1.1;
      font-weight: 400;
    }
    .forecast-card .lowhigh, .forecast-card .wind, .forecast-card .gust, .forecast-card .precip,
    .forecast-card .humidity, .forecast-card .dewpoint, .forecast-card .extra {
      width: 100%;
      display: block;
    }
    .forecast-card .lowhigh {
      font-size: 1.12rem;
      font-weight: 700;
      color: #fff;
      margin-bottom: 0.03em;
      margin-top: 0.03em;
    }
    .forecast-card .wind,
    .forecast-card .gust,
    .forecast-card .precip,
    .forecast-card .humidity,
    .forecast-card .dewpoint {
      font-size: 0.97rem;
      color: #aad7ff;
      margin-bottom: 0.03em;
      font-weight: 400;
    }
    .forecast-card .extra {
      font-size: 0.97rem;
      color: #6afc94;
      margin-top: 4px;
      font-weight: 700;
      line-height: 1.22;
    }
    .forecast-card .hailwarn {
      font-size: 1.08rem;
      color: #ff6b6b;
      font-weight: 700;
      margin-bottom: 3px;
    }
    #popup-bg {
      position: fixed;
      z-index: 99999;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(20, 30, 50, 0.86);
      display: none;
      align-items: center;
      justify-content: center;
    }
    #popup-content {
      background: #232f47;
      border-radius: 18px;
      padding: 36px 54px;
      color: #fff;
      font-size: 1.23rem;
      font-weight: 500;
      max-width: 480px;
      width: 92vw;
      box-shadow: 0 12px 40px #000c;
      line-height: 1.36;
      position: relative;
      text-align: center;
    }
    #popup-close {
      position: absolute;
      top: 10px; right: 22px;
      font-size: 2.3rem;
      color: #aad7ff;
      cursor: pointer;
      background: none;
      border: none;
    }
    #popup-title {
      font-size: 1.18em;
      font-weight: bold;
      margin-bottom: 10px;
    }
    #popup-summary, #popup-lowhigh, #popup-extra {
      margin-bottom: 8px;
    }
    #popup-ai {
      margin-top: 10px;
      font-size: 1.1rem;
      color: #fee680;
    }
    #popup-hist {
      margin-top: 14px;
      color: #aad7ff;
      font-size: 1.03rem;
      line-height: 1.22;
    }
    @media (max-width: 1300px) {
      #main-container { width: 99vw !important; }
      #forecast-block { gap: 5px; }
      .forecast-card { max-width: 120px; }
    }
  </style>
</head>
<body>
  <div id="main-container">
    <div id="current-block" tabindex="0">
      <div id="current-flexrow">
        <div class="current-temp-icon">
          <div class="temp" id="temp">--°C</div>
          <div class="weather-row" id="weather-row">
            <img id="cur-icon" src="" style="display:none;" alt="">
            <span id="weather-text">Loading…</span>
          </div>
        </div>
        <div class="current-cols">
          <div class="col" id="details-col"></div>
          <div class="col">
            <div class="hail-row" id="hail-alert" style="display:none;"></div>
            <div class="rain-row" id="rain-row"></div>
            <div class="today-row" id="today-row"></div>
          </div>
        </div>
      </div>
      <div id="todays-advice">Loading today’s AI advice…</div>
    </div>
    <div id="forecast-block"></div>
  </div>
  <div id="popup-bg">
    <div id="popup-content">
      <button id="popup-close" onclick="closePopup()">&times;</button>
      <div id="popup-title"></div>
      <div id="popup-summary"></div>
      <div id="popup-lowhigh"></div>
      <div id="popup-extra"></div>
      <div id="popup-ai"></div>
      <div id="popup-hist"></div>
    </div>
  </div>
  <script>
    function pastureOutlook(temp, precip) {
      if (temp >= 20 && precip >= 5) return "Pasture growth: Excellent – expect a big jump in covers.";
      if (temp < 10 && precip < 2) return "Pasture growth: Slow – soil temps and moisture are low.";
      return "";
    }
    function dewRisk(humidity, temp) {
      if (humidity && humidity > 85 && temp > 10) return "High dew risk: Allow extra time for paddocks to dry before grazing or mowing.";
      return "";
    }
    function iconUrl(icon) {
      if (!icon) return '';
      return `https://cdn.aerisapi.com/wxblox/icons/${icon}`;
    }
    function dayOfWeek(dateISO) {
      return new Date(dateISO).toLocaleDateString('en-NZ', { weekday: 'short' });
    }
    function capitalize(txt) {
      return (txt || '').charAt(0).toUpperCase() + (txt || '').slice(1);
    }

    function agoraAiAdvice(opts) {
      // Weather/seasonal advice then practical
      const adviceWeather = [
        { cond: d => d.hail, msg: "Hail expected. Shelter livestock and cover equipment to prevent hail damage." },
        { cond: d => d.precip >= 20, msg: "Heavy rain expected. Shift cows off low paddocks and clear drains before milking." },
        { cond: d => d.precip > 10, msg: "Persistent rain. Lay woodchips at gateways and stand-off areas to reduce mud." },
        { cond: d => d.precip > 4, msg: "Showers expected. Hose mud off the yard after milking to keep it safe." },
        { cond: d => d.temp >= 28, msg: "High heat. Delay yarding and ensure fresh water for cows." },
        { cond: d => d.temp > 24 && d.humidity > 70, msg: "Warm, humid weather – facial eczema risk. Start zinc dosing." },
        { cond: d => d.temp < 5, msg: "Cold snap. Add extra bedding for calves and keep sheds closed overnight." },
        { cond: d => d.temp > 20 && d.precip < 2 && d.month >= 1 && d.month <= 3, msg: "Hot and dry. Rotate paddocks early and clean troughs." },
        { cond: d => d.gust > 60, msg: "Strong winds expected. Secure shed doors and check fences." },
        { cond: d => d.temp < 8 && d.month == 8, msg: "Wet, cold August. Use a footbath at shed exit to help lameness." },
        { cond: d => d.temp > 18 && d.precip > 6, msg: "Pasture is lush after rain. Provide hay with grazing to reduce bloat." },
        { cond: d => d.temp < 10 && d.month == 7, msg: "Cold July. Put up windbreaks for calves and ensure dry bedding." }
      ];
      const adviceSeasonal = [
        { cond: d => d.month == 8, msg: "August: Calving. Prepare kit with iodine, towels, and feeders for newborns." },
        { cond: d => d.month == 9, msg: "September: Check springer fences and bedding in shelters." },
        { cond: d => d.month == 10, msg: "October: Plan for mating. Ensure bulls and tail paint are ready." },
        { cond: d => d.month == 11, msg: "November: Check minerals for herd. Prepare magnesium." },
        { cond: d => d.month == 12, msg: "December: Watch for algae. Clean troughs daily." },
        { cond: d => d.month == 1, msg: "January: Hot days. Set up shade and check water supply." },
        { cond: d => d.month == 2, msg: "February: Storms. Make sure fuel and backup are ready." },
        { cond: d => d.month == 3, msg: "March: Secure silage covers and patch holes." },
        { cond: d => d.month == 4, msg: "April: Book winter feed and check covers." },
        { cond: d => d.month == 5, msg: "May: Service the effluent pump before wet weather." },
        { cond: d => d.month == 6, msg: "June: Top up woodchips in stand-off areas, and check heaters." },
        { cond: d => d.month == 7, msg: "July: Clean and disinfect calf pens ready for calving." }
      ];
      const adviceEveryday = [
        "Check paper towels and soap in the wash-up area.",
        "Scrape and rinse the pit floor after milking.",
        "Clear grass/stones from the tanker track.",
        "Sweep steps and plant room to reduce slips.",
        "Check gloves and boots in the shed.",
        "Clean the shed water inlet filter.",
        "Inspect chemical lines/hoses for leaks.",
        "Disinfect calf feeders and hang to dry.",
        "Remove loose twine or rope from yard.",
        "Spray weeds along fence lines.",
        "Check teat spray canister before milking.",
        "Hang milking clusters up at end.",
        "Sweep feed room and remove old meal bags.",
        "Hose down exit race after milking.",
        "Check meal augers for blockages.",
        "Keep vat and silo doors clean and shut.",
        "Walk paddock race and fill deep holes.",
        "Check cow brushes and remove dirt.",
        "Inspect shed for bird nests.",
        "Test tap water temp for cleaning.",
        "Count calves and check all feeding.",
        "Rinse boots before leaving shed.",
        "Top up lime in calf pens for dry bedding.",
        "Brush down cobwebs in dairy/meal room.",
        "Tidy tea room for next break.",
        "Check pasture covers and note areas needing extra rest."
      ];
      const d = {
        month: (opts.dateISO ? new Date(opts.dateISO).getMonth() : new Date().getMonth()) + 1,
        temp: opts.temp,
        humidity: opts.humidity,
        precip: opts.precip,
        gust: opts.gust || 0,
        hail: opts.hail ? true : false
      };
      const hashDay = Math.abs((new Date(opts.dateISO || Date.now())).getDate() +
        ((new Date(opts.dateISO || Date.now())).getMonth() + 1) * 37);

      let advs = [];
      for (let adv of adviceWeather) if (adv.cond(d)) advs.push(adv.msg);
      for (let adv of adviceSeasonal) if (adv.cond(d)) advs.push(adv.msg);
      let rotIndex = hashDay % adviceEveryday.length;
      advs.push(adviceEveryday[rotIndex]);
      advs = advs.filter((v, i, arr) => arr.indexOf(v) === i).slice(0, 2);
      return advs.map(txt => `<div>${txt}</div>`).join('');
    }

    let rainHistory = { today: 0, week: 0, month: 0, year: 0 };

    // Current box
    fetch('https://data.api.xweather.com/conditions/pws_pukerimu?format=json&plimit=1&filter=1min&client_id=U8feQfLlcEfcXDfsWZs4C&client_secret=HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq')
      .then(r => r.json())
      .then(json => {
        if (!json.success) throw new Error('No current conditions');
        const p = json.response[0].periods[0];
        document.getElementById('temp').textContent =
          (typeof p.tempC === 'number') ? `${Math.round(p.tempC)}°C` : '--°C';
        const icon = p.icon || '';
        const icElem = document.getElementById('cur-icon');
        if (icon) {
          icElem.src = iconUrl(icon);
          icElem.style.display = '';
        } else {
          icElem.style.display = 'none';
        }
        document.getElementById('weather-text').textContent = capitalize(p.weather) || '--';

        document.getElementById('details-col').innerHTML =
          `<div><b>Feels like:</b> ${p.feelslikeC !== null && p.feelslikeC !== undefined ? Math.round(p.feelslikeC) + '°C' : 'NA'}</div>
           <div><b>Humidity:</b> ${p.humidity !== null && p.humidity !== undefined ? p.humidity + '%' : 'NA'}</div>
           <div><b>Wind:</b> ${p.windSpeedKPH !== null && p.windSpeedKPH !== undefined ? Math.round(p.windSpeedKPH) + ' km/h' : 'NA'}</div>
           <div><b>Gusts:</b> ${p.windGustKPH !== null && p.windGustKPH !== undefined ? Math.round(p.windGustKPH) + ' km/h' : 'NA'}</div>
           <div><b>Pressure:</b> ${p.pressureMB !== null && p.pressureMB !== undefined ? p.pressureMB + ' hPa' : 'NA'}</div>`;

        const todayRain = (p.precipMM !== null && p.precipMM !== undefined) ? p.precipMM : 0;
        document.getElementById('rain-row').innerHTML = `<b>Rainfall so far:</b> ${todayRain} mm`;
        rainHistory.today = Number(todayRain) || 0;

        document.getElementById('todays-advice').innerHTML = agoraAiAdvice({
          temp: p.tempC,
          humidity: p.humidity,
          gust: p.windGustKPH,
          precip: p.precipMM,
          dateISO: p.dateTimeISO,
          hail: (p.weather || '').toLowerCase().includes('hail')
        });

        // Show hail warning in main box only for today
        const hailElem = document.getElementById('hail-alert');
        if ((p.weather || '').toLowerCase().includes('hail')) {
          hailElem.textContent = '⚠ Hail Warning for Today';
          hailElem.style.display = 'block';
        } else {
          hailElem.style.display = 'none';
        }
      });

    // Forecast (5 cards only, NO scroll)
    fetch('https://data.api.xweather.com/forecasts/pws_pukerimu?format=json&plimit=6&fields=periods.timestamp,periods.dateTimeISO,periods.tempC,periods.weather,periods.icon,periods.maxTempC,periods.minTempC,periods.humidity,periods.precipMM,periods.windSpeedKPH,periods.windGustKPH,periods.dewpointC,periods.summary&client_id=U8feQfLlcEfcXDfsWZs4C&client_secret=HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq')
      .then(r => r.json())
      .then(json => {
        if (!json.success) throw new Error('No forecast');
        const fc = json.response[0].periods || [];
        const fcDom = document.getElementById('forecast-block');
        fcDom.innerHTML = "";
        for (let i = 1; i < fc.length && i <= 5; ++i) {
          const p = fc[i];
          let outlook = pastureOutlook(p.tempC || p.maxTempC, p.precipMM);
          let dew = dewRisk(p.humidity, p.tempC || p.maxTempC);
          let hail = ((p.weather || '') + ' ' + (p.summary || '')).toLowerCase().includes('hail');
          fcDom.innerHTML += `
            <div class="forecast-card" tabindex="0" onclick="openPopup({
                title: '${dayOfWeek(p.dateTimeISO)}',
                summary: '',
                lowhigh: 'High: ${Math.round(p.maxTempC)}°C<br>Low: ${Math.round(p.minTempC)}°C',
                extra: 'Wind: ${Math.round(p.windSpeedKPH || 0)} km/h<br>Gusts: ${Math.round(p.windGustKPH || 0)} km/h<br>Humidity: ${p.humidity !== null && p.humidity !== undefined ? p.humidity + "%" : "NA"}<br>Dew point: ${p.dewpointC !== null && p.dewpointC !== undefined ? Math.round(p.dewpointC) + "°C" : "NA"}<br>Precip: ${p.precipMM || 0} mm'
                  + (hail ? '<br><span style=\'color:#ff6b6b;font-weight:700;\'>⚠ Hail Possible</span>' : '')
                  + (outlook ? '<br><span style=\'color:#6afc94;font-weight:700;\'>' + outlook + '</span>' : '')
                  + (dew ? '<br><span style=\'color:#6afc94;font-weight:700;\'>' + dew + '</span>' : ''),
                ai: \`${agoraAiAdvice({
                  temp: p.tempC || p.maxTempC,
                  humidity: p.humidity,
                  gust: p.windGustKPH,
                  precip: p.precipMM,
                  dateISO: p.dateTimeISO,
                  hail: hail
                })}\`
              })">
              <div class="day">${dayOfWeek(p.dateTimeISO)}</div>
              <img class="icon" src="${iconUrl(p.icon)}" alt="" width="34" height="34">
              <div class="desc">${capitalize(p.weather || '')}</div>
              <div class="lowhigh">High: ${Math.round(p.maxTempC)}°C<br>Low: ${Math.round(p.minTempC)}°C</div>
              <div class="wind">Wind: ${Math.round(p.windSpeedKPH || 0)} km/h</div>
              <div class="gust">Gusts: ${Math.round(p.windGustKPH || 0)} km/h</div>
              <div class="precip">Precip: ${p.precipMM || 0} mm</div>
              <div class="humidity">Humidity: ${p.humidity !== null && p.humidity !== undefined ? p.humidity + '%' : 'NA'}</div>
              <div class="dewpoint">Dew point: ${p.dewpointC !== null && p.dewpointC !== undefined ? Math.round(p.dewpointC) + '°C' : 'NA'}</div>
            </div>
          `;
        }
      });

    function openPopup(opts) {
      document.getElementById('popup-title').textContent = opts.title || "";
      document.getElementById('popup-summary').textContent = opts.summary || "";
      document.getElementById('popup-lowhigh').innerHTML = opts.lowhigh || "";
      document.getElementById('popup-extra').innerHTML = opts.extra || "";
      document.getElementById('popup-ai').innerHTML = opts.ai || "";
      document.getElementById('popup-hist').innerHTML = opts.hist || "";
      document.getElementById('popup-bg').style.display = 'flex';
    }
    function closePopup() {
      document.getElementById('popup-bg').style.display = 'none';
    }
    document.getElementById('popup-bg').onclick = (e) => {
      if (e.target === e.currentTarget) closePopup();
    };
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closePopup();
    });
  </script>
</body>
</html>